<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pixel Master + Mini Oyun</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<!-- ADDED: Firebase compat (modulesuz, inline onclick bozulmaz) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
:root{ --neon-pink:#ff00ff; --neon-blue:#00ffff; --good:#00ff66; --bad:#ff3355; }

*{box-sizing:border-box;margin:0;padding:0;}
body,html{
  width:100%;height:100%;
  font-family:'Press Start 2P', cursive;
  background:radial-gradient(circle at 50% 50%,#1a1a2e 0%,#000 100%);
  color:#fff;
  display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
  padding:18px 10px;
}
.hidden{display:none !important;}

@keyframes neonFadeIn{
  0%{opacity:0; filter:drop-shadow(0 0 0px #ff00ff);}
  50%{opacity:.5; filter:drop-shadow(0 0 8px #ff00ff);}
  100%{opacity:1; filter:drop-shadow(0 0 20px #ff00ff);}
}
.neon-show{ animation:neonFadeIn .7s ease forwards; }

h2,p{ text-align:center; line-height:1.45; }
small{ opacity:.8; }

button{
  padding:10px 14px; cursor:pointer;
  font-family:'Press Start 2P';
  border:2px solid var(--neon-pink);
  color:var(--neon-pink);
  background:transparent;
  border-radius:10px;
  transition:.25s;
}
button:hover{ background:var(--neon-pink); color:#000; box-shadow:0 0 15px var(--neon-pink); }
button:disabled{ opacity:.45; cursor:not-allowed; }

input{
  padding:10px 12px;
  border-radius:10px;
  border:2px solid var(--neon-blue);
  background:#0b0b0f;
  color:#fff;
  font-family:'Press Start 2P';
  outline:none;
  width:min(420px, 90vw);
}

.controls{
  display:flex;justify-content:center;align-items:center;
  gap:10px;flex-wrap:wrap;margin-top:12px;
}

.panel{
  width:min(980px, 95vw);
  display:flex;flex-direction:column;align-items:center;
  gap:10px;
}

#character-canvas{
  width:350px;height:480px;
  background:linear-gradient(145deg,#0c0c12,#1a1a2a);
  border:2px solid var(--neon-blue);
  border-radius:16px;
  display:flex;justify-content:center;align-items:center;
  box-shadow:0 0 15px rgba(255,0,255,.35);
  margin:10px 0;
}

#dolap-list{
  display:flex;flex-wrap:wrap;gap:14px;justify-content:center;
  padding:10px;max-width:95vw;
  overflow-y:auto;max-height:55vh;
}
.character-card{
  background:rgba(0,0,0,0.65);
  padding:10px;border:2px solid var(--neon-blue);
  border-radius:12px;text-align:center;width:160px;
  display:flex;flex-direction:column;align-items:center;gap:8px;
}
.character-card svg{width:92px;height:120px;}
.character-card .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}

.badge{
  border:1px solid rgba(255,255,255,.25);
  padding:8px 10px;
  border-radius:12px;
  background:rgba(0,0,0,.35);
  width:min(820px, 95vw);
}
.badge b{ color:var(--neon-blue); }

canvas{
  border:2px solid var(--neon-pink);
  border-radius:12px;
  background:#0a0a0f;
  box-shadow:0 0 15px rgba(255,0,255,.28);
}

.grid3{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap:10px;
  width:min(820px, 95vw);
}
@media (max-width:900px){
  .grid3{ grid-template-columns: 1fr; }
}
.game-btn{
  padding:14px 12px;
  border:2px solid var(--neon-blue);
  color:var(--neon-blue);
}
.game-btn:hover{ background:var(--neon-blue); color:#000; box-shadow:0 0 15px var(--neon-blue); }

.hr{
  width:min(820px,95vw);
  height:2px;
  background:linear-gradient(90deg, transparent, rgba(0,255,255,.6), transparent);
  margin:10px 0;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="panel neon-show">
  <p>Takma adƒ±nƒ± gir</p>
  <input id="nickname" placeholder="Takma ad">
  <button id="btn-enter">Gƒ∞R</button>
</div>

<!-- MENU -->
<div id="menu" class="panel hidden">
  <h2>Merhaba <span id="display-nick"></span>!</h2>
  <div class="controls">
    <button id="btn-library">Dolap</button>
    <button id="btn-creator">Olu≈ütur</button>
    <button id="btn-games">OYUNLAR</button>
    <button onclick="openOnline()">ONLINE MOD</button>
  </div>
</div>

<!-- CREATOR -->
<div id="creator" class="panel hidden">
  <h2>Karakter Olu≈ütur</h2>
  <div class="badge" id="unlock-badge"></div>
  <div id="character-canvas"></div>
  <div class="controls">
    <button onclick="change('hair')">Sa√ß</button>
    <button onclick="change('top')">√úst</button>
    <button onclick="change('bottom')">Alt</button>
    <button onclick="change('shoes')">Ayakkabƒ±</button>
    <button onclick="saveCurrentCharacter()">Kaydet</button>
    <button onclick="backToMenu()">Geri</button>
  </div>
</div>

<!-- LIBRARY -->
<div id="library" class="panel hidden">
  <h2>Dolap</h2>
  <p><small>Karakter kartƒ±na tƒ±kla: ‚Äúaktif karakter‚Äù yapar (oyunlarda k√∂≈üede √ßƒ±kar).</small></p>
  <div id="dolap-list"></div>
  <div class="controls">
    <button onclick="backToMenu()">Geri</button>
  </div>
</div>

<!-- GAMES HUB -->

<!-- ONLINE MOD -->
<div id="online" class="panel hidden">
  <h2>Online Mod</h2>

  <button onclick="createRoom()">Oda Olu≈ütur</button>

  <p>‚Äî veya ‚Äî</p>

  <input id="joinCode" placeholder="5 haneli kod">
  <button onclick="joinRoom()">Odaya Gir</button>

  <button onclick="backToMenu()">Geri</button>
</div>

<!-- ADDED: ROOM SCREEN (yan yana panel) -->
<div id="room" class="panel hidden">
  <div id="room-code" style="position:fixed;top:10px;left:10px;color:#00ffff">ODA: -----</div>

  <div style="display:flex;gap:40px;flex-wrap:wrap;justify-content:center;width:min(900px,95vw)">
    <div>
      <h2>Sen</h2>
      <div id="my-character"></div>
      <div class="controls">
        <button onclick="change('hair')">Sa√ß</button>
        <button onclick="change('top')">√úst</button>
        <button onclick="change('bottom')">Alt</button>
        <button onclick="change('shoes')">Ayakkabƒ±</button>
      </div>
    </div>

    <div>
      <h2>Arkada≈ü</h2>
      <div id="friend-character"></div>
    </div>
  </div>

  <div class="controls">
    <button onclick="leaveRoom()">Geri</button>
  </div>
</div>

<div id="games" class="panel hidden">
  <h2>OYUNLAR</h2>

  <div class="badge" id="quest-box"></div>

  <div class="grid3">
    <button class="game-btn" onclick="openGame('bounce')">Neon Bounce</button>
    <button class="game-btn" onclick="openGame('reaction')">Reaction Rush</button>
    <button class="game-btn" onclick="openGame('runner')">Neon Runner</button>
  </div>

  <div class="controls">
    <button onclick="backToMenu()">Geri</button>
  </div>
</div>

<!-- GAME SCREEN -->
<div id="game" class="panel hidden">
  <h2 id="game-title">Oyun</h2>
  <div class="badge" id="hud"></div>
  <canvas id="game-canvas" width="360" height="520"></canvas>
  <div class="controls">
    <button id="btn-restart">Yeniden</button>
    <button onclick="openGamesHub()">Oyunlar</button>
    <button onclick="backToMenu()">Men√º</button>
  </div>
</div>

<script>
/* -------------------- STORAGE HELPERS -------------------- */
const LS = {
  get(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch{ return def; } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
  getStr(k, def=""){ return localStorage.getItem(k) ?? def; },
  setStr(k, v){ localStorage.setItem(k, v); }
};

function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

/* -------------------- DAILY QUEST / UNLOCK -------------------- */
// Quest: "Bug√ºn 20 puan yap" (herhangi bir oyunda puan)
// Reward: Neon Pack (ek ekstra itemler)
function getProgress(){
  const p = LS.get("dailyProgress", null);
  const t = todayKey();
  if(!p || p.day !== t){
    const fresh = { day:t, score:0, completed:false, claimed:false };
    LS.set("dailyProgress", fresh);
    return fresh;
  }
  return p;
}
function saveProgress(p){ LS.set("dailyProgress", p); }
function addScoreToDaily(amount){
  const p = getProgress();
  if(p.completed) return;
  p.score = Math.max(0, (p.score||0) + amount);
  if(p.score >= 20){
    p.score = 20;
    p.completed = true;
  }
  saveProgress(p);
  updateQuestUI();
  updateUnlockBadge();
}
function claimReward(){
  const p = getProgress();
  if(!p.completed || p.claimed) return;
  p.claimed = true;
  saveProgress(p);
  LS.set("neonPackUnlocked", true);
  updateQuestUI();
  updateUnlockBadge();
  alert("NEON PACK a√ßƒ±ldƒ±! (ekstra sa√ß/√ºst/alt/ayakkabƒ±)");
}

/* -------------------- CHARACTER ASSETS -------------------- */
const bodyBase = `
<rect x="35" y="30" width="30" height="30" fill="#ffdbac"/>
<rect x="40" y="60" width="20" height="40" fill="#ffdbac"/>
<rect x="40" y="100" width="9" height="40" fill="#ffdbac"/>
<rect x="51" y="100" width="9" height="40" fill="#ffdbac"/>
`;

const baseAssets = {
  hair:[
    `<rect x="35" y="25" width="30" height="10" fill="#4d2600"/>`,
    `<rect x="32" y="20" width="36" height="20" fill="#ffd700"/>`,
    `<rect x="30" y="18" width="40" height="22" fill="#00ffff"/>`,
    `<rect x="35" y="25" width="30" height="10" fill="#ff00ff"/>`,
    `<rect x="32" y="20" width="36" height="20" fill="#ff4500"/>`,
    `<rect x="30" y="18" width="40" height="22" fill="#00ff00"/>`,
    `<rect x="34" y="23" width="32" height="12" fill="#1e90ff"/>`,
    `<rect x="33" y="21" width="34" height="14" fill="#ff1493"/>`,
    `<rect x="35" y="22" width="30" height="15" fill="#ffa500"/>`,
    `<rect x="31" y="19" width="38" height="18" fill="#adff2f"/>`
  ],
  top:[
    `<rect x="40" y="60" width="20" height="35" fill="#ff0055"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#222"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#00ff00"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ff00ff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#1e90ff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ffa500"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#00ffff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#adff2f"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ff4500"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ff1493"/>`
  ],
  bottom:[
    `<rect x="40" y="95" width="9" height="45" fill="#2b2b80"/><rect x="51" y="95" width="9" height="45" fill="#2b2b80"/>`,
    `<rect x="40" y="95" width="20" height="15" fill="#555"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ff00ff"/><rect x="51" y="95" width="9" height="45" fill="#ff00ff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#00ffff"/><rect x="51" y="95" width="9" height="45" fill="#00ffff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ffa500"/><rect x="51" y="95" width="9" height="45" fill="#ffa500"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ff1493"/><rect x="51" y="95" width="9" height="45" fill="#ff1493"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#1e90ff"/><rect x="51" y="95" width="9" height="45" fill="#1e90ff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#00ff00"/><rect x="51" y="95" width="9" height="45" fill="#00ff00"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ff4500"/><rect x="51" y="95" width="9" height="45" fill="#ff4500"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#adff2f"/><rect x="51" y="95" width="9" height="45" fill="#adff2f"/>`
  ],
  shoes:[
    `<rect x="38" y="140" width="14" height="6" fill="#000"/><rect x="52" y="140" width="14" height="6" fill="#000"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="red"/><rect x="52" y="140" width="14" height="6" fill="red"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="blue"/><rect x="52" y="140" width="14" height="6" fill="blue"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="green"/><rect x="52" y="140" width="14" height="6" fill="green"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#ff00ff"/><rect x="52" y="140" width="14" height="6" fill="#ff00ff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#00ffff"/><rect x="52" y="140" width="14" height="6" fill="#00ffff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#ffd700"/><rect x="52" y="140" width="14" height="6" fill="#ffd700"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#555"/><rect x="52" y="140" width="14" height="6" fill="#555"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#fff"/><rect x="52" y="140" width="14" height="6" fill="#fff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#8b4513"/><rect x="52" y="140" width="14" height="6" fill="#8b4513"/>`
  ]
};

// Reward pack (Neon Pack) ‚Äì ekstra 5‚Äôer tane
const neonPack = {
  hair:[
    `<rect x="29" y="18" width="42" height="20" fill="#9b5cff"/><rect x="31" y="22" width="38" height="6" fill="#00ffff"/>`,
    `<rect x="31" y="18" width="38" height="22" fill="#00ff66"/>`,
    `<rect x="30" y="20" width="40" height="18" fill="#ff3355"/>`,
    `<rect x="32" y="18" width="36" height="22" fill="#ffffff"/><rect x="33" y="22" width="34" height="4" fill="#ff00ff"/>`,
    `<rect x="30" y="18" width="40" height="22" fill="#222"/><rect x="30" y="18" width="40" height="4" fill="#00ffff"/>`
  ],
  top:[
    `<rect x="40" y="60" width="20" height="35" fill="#9b5cff"/><rect x="40" y="74" width="20" height="4" fill="#00ffff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#00ff66"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ff3355"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#fff"/><rect x="40" y="66" width="20" height="4" fill="#ff00ff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#111"/><rect x="40" y="60" width="20" height="3" fill="#00ffff"/>`
  ],
  bottom:[
    `<rect x="40" y="95" width="9" height="45" fill="#9b5cff"/><rect x="51" y="95" width="9" height="45" fill="#9b5cff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#00ff66"/><rect x="51" y="95" width="9" height="45" fill="#00ff66"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ff3355"/><rect x="51" y="95" width="9" height="45" fill="#ff3355"/>`,
    `<rect x="40" y="95" width="20" height="15" fill="#fff"/><rect x="40" y="110" width="20" height="3" fill="#ff00ff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#111"/><rect x="51" y="95" width="9" height="45" fill="#111"/><rect x="40" y="95" width="20" height="3" fill="#00ffff"/>`
  ],
  shoes:[
    `<rect x="38" y="140" width="14" height="6" fill="#9b5cff"/><rect x="52" y="140" width="14" height="6" fill="#9b5cff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#00ff66"/><rect x="52" y="140" width="14" height="6" fill="#00ff66"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#ff3355"/><rect x="52" y="140" width="14" height="6" fill="#ff3355"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#fff"/><rect x="52" y="140" width="14" height="6" fill="#fff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#111"/><rect x="52" y="140" width="14" height="6" fill="#111"/><rect x="38" y="140" width="28" height="2" fill="#00ffff"/>`
  ]
};

function neonUnlocked(){ return !!LS.get("neonPackUnlocked", false); }
function getAssetList(cat){
  const base = baseAssets[cat];
  if(neonUnlocked()) return base.concat(neonPack[cat]);
  return base;
}

let currentIndices = { hair:0, top:0, bottom:0, shoes:0 };

function renderCharacter(){
  const canvas = document.getElementById('character-canvas');
  const hairList = getAssetList("hair");
  const topList = getAssetList("top");
  const bottomList = getAssetList("bottom");
  const shoesList = getAssetList("shoes");

  // index ta≈ümasƒ±n
  currentIndices.hair %= hairList.length;
  currentIndices.top %= topList.length;
  currentIndices.bottom %= bottomList.length;
  currentIndices.shoes %= shoesList.length;

  canvas.innerHTML = `
    <svg viewBox="0 0 100 160" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%">
      ${bodyBase}
      ${hairList[currentIndices.hair]}
      ${topList[currentIndices.top]}
      ${bottomList[currentIndices.bottom]}
      ${shoesList[currentIndices.shoes]}
    </svg>
  `;
}

function change(cat){
  const list = getAssetList(cat);
  currentIndices[cat] = (currentIndices[cat] + 1) % list.length;
  renderCharacter();

  // ADDED: online odadaysa anƒ±nda firebase'e g√∂nder
  if(roomCode && slot && db){
    db.ref(`rooms/${roomCode}/${slot}`).update({ character: currentIndices });
  }
}

/* ===================== ADDED: FIREBASE + ONLINE ODA ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyABqkhpL1SMRzRJ9GQLjjZE2IryqpAvMPw",
  authDomain: "pixelroom-ae218.firebaseapp.com",
  projectId: "pixelroom-ae218",
  storageBucket: "pixelroom-ae218.firebasestorage.app",
  messagingSenderId: "720297722320",
  appId: "1:720297722320:web:c815edae99d1efa7ff39d5",
  measurementId: "G-HD8901B19M",

  // ADDED: RTDB i√ßin ≈üart
  databaseURL: "https://pixelroom-ae218-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);
firebase.auth().signInAnonymously();
const db = firebase.database();

let roomCode = null;
let slot = null; // "p1" / "p2"

function generateRoomCode(){
  return Math.floor(10000 + Math.random()*90000).toString();
}

function openOnline(){
  stopAnyGame();
  hideAll();
  showPanel("online");
}

// roomdaki iki paneli √ßiz
function drawCharacterFromIndices(indices, targetId){
  const target = document.getElementById(targetId);
  if(!target) return;

  if(!indices){
    target.innerHTML = `<p><small>Bekleniyor‚Ä¶</small></p>`;
    return;
  }

  const hairList = getAssetList("hair");
  const topList = getAssetList("top");
  const bottomList = getAssetList("bottom");
  const shoesList = getAssetList("shoes");

  target.innerHTML = `
    <svg viewBox="0 0 100 160" xmlns="http://www.w3.org/2000/svg" width="220" height="320">
      ${bodyBase}
      ${hairList[indices.hair % hairList.length]}
      ${topList[indices.top % topList.length]}
      ${bottomList[indices.bottom % bottomList.length]}
      ${shoesList[indices.shoes % shoesList.length]}
    </svg>
  `;
}

function listenRoom(){
  db.ref("rooms/" + roomCode).on("value", snap=>{
    const data = snap.val();
    if(!data){
      leaveRoom(true);
      return;
    }

    // ben
    drawCharacterFromIndices(data[slot]?.character, "my-character");

    // arkada≈ü
    const other = (slot === "p1") ? "p2" : "p1";
    drawCharacterFromIndices(data[other]?.character, "friend-character");
  });
}

function createRoom(){
  roomCode = generateRoomCode();
  slot = "p1";

  db.ref("rooms/" + roomCode).set({
    p1: { character: currentIndices },
    p2: null,
    createdAt: Date.now()
  });

  const codeEl = document.getElementById("room-code");
  if(codeEl) codeEl.textContent = "ODA: " + roomCode;

  hideAll();
  showPanel("room");
  listenRoom();
}

function joinRoom(){
  const code = document.getElementById("joinCode").value.trim();
  if(code.length !== 5) return alert("5 haneli kod gir");

  roomCode = code;
  slot = "p2";

  db.ref("rooms/" + roomCode).once("value").then(snap=>{
    if(!snap.exists()) return alert("Oda yok");
    const data = snap.val();
    if(data.p2) return alert("Oda dolu");

    db.ref(`rooms/${roomCode}/p2`).set({ character: currentIndices });

    const codeEl = document.getElementById("room-code");
    if(codeEl) codeEl.textContent = "ODA: " + roomCode;

    hideAll();
    showPanel("room");
    listenRoom();
  });
}

function leaveRoom(silent=false){
  if(roomCode && slot){
    if(slot === "p2"){
      db.ref(`rooms/${roomCode}/p2`).remove();
    }else{
      db.ref(`rooms/${roomCode}`).remove();
    }
    db.ref("rooms/" + roomCode).off();
  }
  roomCode = null;
  slot = null;

  if(!silent) backToMenu();
}
/* ===================== ADDED END ===================== */

/* -------------------- PAGES -------------------- */
function hideAll(){
  // CHANGED (zorunlu): online + room da gizlensin
  ["login","menu","creator","library","online","room","games","game"].forEach(id=>{
    document.getElementById(id).classList.add("hidden");
  });
}
function showPanel(id){
  const el = document.getElementById(id);
  el.classList.remove("hidden");
  el.classList.remove("neon-show");
  void el.offsetWidth;
  el.classList.add("neon-show");
}

function enterSite(){
  const nick = document.getElementById('nickname').value.trim();
  if(!nick) return alert("Takma ad bo≈ü olamaz!");
  LS.setStr("nickname", nick);
  document.getElementById("display-nick").textContent = nick;
  hideAll();
  showPanel("menu");
}

function openCreator(){
  stopAnyGame();
  hideAll();
  showPanel("creator");
  updateUnlockBadge();
  renderCharacter();
}

function openLibrary(){
  stopAnyGame();
  hideAll();
  showPanel("library");
  loadLibrary();
}

function openGamesHub(){
  stopAnyGame();
  hideAll();
  showPanel("games");
  updateQuestUI();
}

function backToMenu(){
  stopAnyGame();
  hideAll();
  showPanel("menu");
}

/* -------------------- UNLOCK UI -------------------- */
function updateUnlockBadge(){
  const b = document.getElementById("unlock-badge");
  if(neonUnlocked()){
    b.innerHTML = `Neon Pack: <b>A√áIK</b> ‚úÖ (ekstra itemler aktif)`;
  }else{
    const p = getProgress();
    b.innerHTML = `Neon Pack: <b>Kƒ∞Lƒ∞TLƒ∞</b> üîí | G√ºnl√ºk g√∂rev puanƒ±: <b>${p.score}/20</b>`;
  }
}

function updateQuestUI(){
  const box = document.getElementById("quest-box");
  const p = getProgress();
  const unlocked = neonUnlocked();

  let status = `G√ºnl√ºk g√∂rev: <b>20 puan</b> yap (${p.score}/20)`;
  if(p.completed) status = `G√ºnl√ºk g√∂rev: <b>TAMAM</b> ‚úÖ (20/20)`;

  let claimBtn = "";
  if(p.completed && !p.claimed){
    claimBtn = `<div class="controls" style="margin-top:10px">
      <button id="btn-claim" style="border-color:var(--good);color:var(--good)">√ñD√úL√ú AL</button>
    </div>`;
  }else if(p.claimed || unlocked){
    claimBtn = `<p style="margin-top:10px;color:var(--good)">√ñd√ºl alƒ±ndƒ±: Neon Pack ‚úÖ</p>`;
  }

  box.innerHTML = `
    <p>${status}</p>
    <p><small>Not: Herhangi bir oyunda puan kazanman yeter.</small></p>
    ${claimBtn}
  `;

  const btn = document.getElementById("btn-claim");
  if(btn) btn.onclick = claimReward;
}

/* -------------------- DOLAP -------------------- */
function saveCurrentCharacter(){
  const nick = LS.getStr("nickname","anon");

  const hairList = getAssetList("hair");
  const topList = getAssetList("top");
  const bottomList = getAssetList("bottom");
  const shoesList = getAssetList("shoes");

  const svg = `
  <svg viewBox="0 0 100 160" xmlns="http://www.w3.org/2000/svg">
    ${bodyBase}
    ${hairList[currentIndices.hair]}
    ${topList[currentIndices.top]}
    ${bottomList[currentIndices.bottom]}
    ${shoesList[currentIndices.shoes]}
  </svg>`;

  const saved = LS.get("savedCharacters", []);
  saved.push({ nick, svg, ts: Date.now() });
  LS.set("savedCharacters", saved);
  alert("Karakter kaydedildi!");
}

function loadLibrary(){
  const nick = LS.getStr("nickname","");
  const container = document.getElementById("dolap-list");
  container.innerHTML = "";

  const saved = LS.get("savedCharacters", []);
  const my = saved.filter(x => x.nick === nick);

  if(my.length === 0){
    const d = document.createElement("div");
    d.textContent = "Hen√ºz karakter yok.";
    container.appendChild(d);
    return;
  }

  my.slice().reverse().forEach((c) => {
    const card = document.createElement("div");
    card.className = "character-card";
    card.innerHTML = `
      <div class="preview">${c.svg}</div>
      <p>${c.nick}</p>
      <div class="row">
        <button style="border-color:var(--neon-blue);color:var(--neon-blue)">AKTƒ∞F</button>
      </div>
    `;

    // karta tƒ±kla -> aktif yap
    card.onclick = () => {
      LS.setStr("activeCharacterSVG", c.svg);
      alert("Aktif karakter ayarlandƒ±! (oyunlarda k√∂≈üede g√∂r√ºnecek)");
    };

    container.appendChild(card);
  });
}

/* -------------------- GAME SYSTEM (3 oyun) -------------------- */
const canvas = document.getElementById("game-canvas");
const ctx = canvas.getContext("2d");
let currentGame = null;

// common ui
function openGame(which){
  hideAll();
  showPanel("game");
  document.getElementById("btn-restart").onclick = () => startGame(which);
  startGame(which);
}

function startGame(which){
  stopAnyGame();
  currentGame = which;

  if(which === "bounce") startBounce();
  else if(which === "reaction") startReaction();
  else if(which === "runner") startRunner();
}

function stopAnyGame(){
  stopBounce();
  stopReaction();
  stopRunner();
  currentGame = null;
}

// draw active character avatar at corner (if exists)
function drawActiveAvatar(){
  const svg = LS.getStr("activeCharacterSVG","");
  if(!svg) return;

  // basit: k√∂≈üeye mini stick/pixel ikon yerine k√º√ß√ºk √ßer√ßeve + yazƒ±
  ctx.save();
  ctx.globalAlpha = 0.9;
  ctx.fillStyle = "rgba(0,0,0,0.35)";
  ctx.fillRect(8, 8, 92, 62);
  ctx.strokeStyle = "#00ffff";
  ctx.lineWidth = 2;
  ctx.strokeRect(8, 8, 92, 62);
  ctx.fillStyle = "#00ffff";
  ctx.font = "10px 'Press Start 2P'";
  ctx.fillText("AKTƒ∞F", 16, 34);
  ctx.restore();
}

/* ==================== (4) EFFECTS HELPERS ==================== */
let particles = [];
function spawnParticles(x,y, count=14){
  for(let i=0;i<count;i++){
    particles.push({
      x,y,
      vx:(Math.random()-0.5)*5,
      vy:(Math.random()-0.5)*5,
      life: 18 + Math.random()*10
    });
  }
}
function updateParticles(){
  for(const p of particles){
    p.x += p.vx;
    p.y += p.vy;
    p.vx *= 0.95;
    p.vy *= 0.95;
    p.life -= 1;
  }
  particles = particles.filter(p => p.life > 0);
}
function drawParticles(){
  for(const p of particles){
    ctx.save();
    ctx.globalAlpha = Math.max(0, p.life/28);
    ctx.fillStyle = "#ff00ff";
    ctx.beginPath();
    ctx.arc(p.x, p.y, 2.2, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }
}
let shake = 0;
function addShake(power=7){ shake = Math.max(shake, power); }

/* ==================== GAME 1: NEON BOUNCE ==================== */
let bounceInterval = null;
let bounce = null;

function startBounce(){
  document.getElementById("game-title").textContent = "Neon Bounce";
  bounce = {
    score:0,
    lives:3,
    wallH: 14,
    ball:{ x:canvas.width/2, y:canvas.height/2, dx:2.4, dy:-3.1, r:10 },
    speedUpEvery: 10
  };

  canvas.onclick = () => { bounce.ball.dy *= -1; };

  bounceInterval = setInterval(() => {
    // TRAIL: komple silmek yerine ≈üeffaf katman
    ctx.save();
    ctx.fillStyle = "rgba(10,10,15,0.22)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.restore();

    // SHAKE
    let sx = 0, sy = 0;
    if(shake > 0){
      sx = (Math.random()-0.5) * shake;
      sy = (Math.random()-0.5) * shake;
      shake *= 0.82;
      if(shake < 0.7) shake = 0;
    }
    ctx.save();
    ctx.translate(sx, sy);

    // wall
    ctx.fillStyle = "red";
    ctx.fillRect(0,0,canvas.width,bounce.wallH);

    // ball
    ctx.fillStyle = "yellow";
    ctx.beginPath();
    ctx.arc(bounce.ball.x, bounce.ball.y, bounce.ball.r, 0, Math.PI*2);
    ctx.fill();

    // update ball
    const b = bounce.ball;
    b.x += b.dx;
    b.y += b.dy;

    let bounced = false;

    if(b.x + b.r > canvas.width){ b.x = canvas.width - b.r; b.dx *= -1; bounced = true; }
    if(b.x - b.r < 0){ b.x = b.r; b.dx *= -1; bounced = true; }

    // top wall hit => SCORE
    if(b.y - b.r < bounce.wallH){
      b.y = bounce.wallH + b.r;
      b.dy *= -1;
      bounced = true;

      bounce.score += 1;
      addScoreToDaily(1); // (3) daily progress

      // speed up
      if(bounce.score % bounce.speedUpEvery === 0){
        b.dx *= 1.08;
        b.dy *= 1.08;
      }
    }

    // bottom => lose life
    if(b.y + b.r > canvas.height){
      bounce.lives -= 1;
      spawnParticles(b.x, canvas.height - 10, 28);
      addShake(12);

      if(bounce.lives <= 0){
        bounce.lives = 0;
        canvas.onclick = null;
        stopBounce();
        // final hud
        document.getElementById("hud").innerHTML =
          `SKOR: <b>${bounce.score}</b> | CAN: <b style="color:var(--bad)">0</b><br><small>Yeniden‚Äôe bas</small>`;
        return;
      }else{
        // reset ball
        b.x = canvas.width/2; b.y = canvas.height/2;
        b.dx = 2.4; b.dy = -3.1;
      }
    }

    if(bounced){
      spawnParticles(b.x, b.y, 14);
      addShake(7);
    }

    updateParticles();
    drawParticles();

    drawActiveAvatar();
    ctx.restore();

    document.getElementById("hud").innerHTML =
      `SKOR: <b>${bounce.score}</b> | CAN: <b>${bounce.lives}</b><br><small>Topa tƒ±kla: y√∂n deƒüi≈ütir</small>`;
  }, 16);
}

function stopBounce(){
  if(bounceInterval){
    clearInterval(bounceInterval);
    bounceInterval = null;
  }
  // bounce oyunu dƒ±≈üƒ±nda onclick‚Äôi temizleme: stopAnyGame i√ßinde zaten
}

/* ==================== GAME 2: REACTION RUSH ==================== */
let reaction = null;
let reactionTimer = null;
let reactionStateTimer = null;

function startReaction(){
  document.getElementById("game-title").textContent = "Reaction Rush";
  reaction = {
    best: LS.get("bestReactionMs", null),
    startedAt: null,
    canClick:false,
    last: null,
    round: 0,
    score: 0
  };

  // temiz ekran
  ctx.fillStyle = "rgba(10,10,15,1)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  function scheduleRound(){
    reaction.canClick = false;
    reaction.startedAt = null;
    reaction.round += 1;

    // ‚Äúbekle‚Äù ekranƒ±
    ctx.fillStyle = "rgba(10,10,15,1)";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle = "#00ffff";
    ctx.font = "12px 'Press Start 2P'";
    ctx.fillText("BEKLE...", 110, 250);

    const delay = 900 + Math.random()*1600;

    reactionStateTimer = setTimeout(() => {
      // hedef √ßƒ±ktƒ±
      reaction.canClick = true;
      reaction.startedAt = performance.now();

      ctx.fillStyle = "rgba(10,10,15,1)";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // target
      const tx = 90 + Math.random()*(canvas.width-180);
      const ty = 120 + Math.random()*(canvas.height-240);
      reaction.target = { x:tx, y:ty, r:32 };

      // glow target
      ctx.save();
      ctx.shadowColor = "#ff00ff";
      ctx.shadowBlur = 25;
      ctx.fillStyle = "#ff00ff";
      ctx.beginPath(); ctx.arc(tx,ty,32,0,Math.PI*2); ctx.fill();
      ctx.restore();

      ctx.fillStyle = "#000";
      ctx.font = "10px 'Press Start 2P'";
      ctx.fillText("TIKLA", tx-22, ty+4);

      document.getElementById("hud").innerHTML =
        `ROUND: <b>${reaction.round}</b> | PUAN: <b>${reaction.score}</b><br><small>Hedef √ßƒ±kƒ±nca tƒ±kla</small>`;
    }, delay);
  }

  canvas.onclick = (e) => {
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * (canvas.width / rect.width);
    const my = (e.clientY - rect.top) * (canvas.height / rect.height);

    if(!reaction.canClick){
      // erken tƒ±kladƒ± -> ceza
      reaction.score = Math.max(0, reaction.score - 1);
      spawnParticles(mx,my,18);
      addShake(10);
      document.getElementById("hud").innerHTML =
        `ERKEN! PUAN: <b>${reaction.score}</b><br><small>Hedef √ßƒ±kƒ±nca bas</small>`;
      return;
    }

    // hedefe vurdu mu?
    const dx = mx - reaction.target.x;
    const dy = my - reaction.target.y;
    const dist = Math.sqrt(dx*dx + dy*dy);

    if(dist <= reaction.target.r){
      const ms = Math.round(performance.now() - reaction.startedAt);
      reaction.last = ms;

      // scoring: hƒ±zlƒ±ysa daha √ßok
      let gained = 1;
      if(ms < 250) gained = 3;
      else if(ms < 400) gained = 2;

      reaction.score += gained;
      addScoreToDaily(gained);

      // best
      if(reaction.best === null || ms < reaction.best){
        reaction.best = ms;
        LS.set("bestReactionMs", ms);
      }

      spawnParticles(reaction.target.x, reaction.target.y, 30);
      addShake(8);

      // sonu√ß ekranƒ±
      ctx.fillStyle = "rgba(10,10,15,1)";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.fillStyle = "#00ff66";
      ctx.font = "12px 'Press Start 2P'";
      ctx.fillText("S√úPER!", 120, 220);
      ctx.fillStyle = "#00ffff";
      ctx.font = "10px 'Press Start 2P'";
      ctx.fillText(`TEPKƒ∞: ${ms}ms`, 85, 260);
      ctx.fillText(`BEST: ${reaction.best}ms`, 85, 290);

      document.getElementById("hud").innerHTML =
        `PUAN: <b>${reaction.score}</b> | SON: <b>${ms}ms</b> | BEST: <b>${reaction.best}ms</b>`;

      reaction.canClick = false;

      clearTimeout(reactionTimer);
      reactionTimer = setTimeout(scheduleRound, 900);
    }else{
      // ƒ±skaladƒ±
      reaction.score = Math.max(0, reaction.score - 1);
      spawnParticles(mx,my,14);
      addShake(6);
      document.getElementById("hud").innerHTML =
        `ISKA! PUAN: <b>${reaction.score}</b><br><small>Hedefe bas</small>`;
    }
  };

  scheduleRound();
}

function stopReaction(){
  if(reactionStateTimer){ clearTimeout(reactionStateTimer); reactionStateTimer = null; }
  if(reactionTimer){ clearTimeout(reactionTimer); reactionTimer = null; }
}

/* ==================== GAME 3: NEON RUNNER ==================== */
let runnerInterval = null;
let runner = null;

function startRunner(){
  document.getElementById("game-title").textContent = "Neon Runner";
  runner = {
    score: 0,
    lives: 3,
    y: canvas.height - 70,
    vy: 0,
    onGround: true,
    obstacles: [],
    t: 0,
    speed: 3.2
  };

  canvas.onclick = () => {
    // zƒ±pla
    if(runner.onGround){
      runner.vy = -10.8;
      runner.onGround = false;
      spawnParticles(70, runner.y+30, 18);
      addShake(6);
    }
  };

  runnerInterval = setInterval(() => {
    // trail
    ctx.fillStyle = "rgba(10,10,15,0.25)";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // shake
    let sx=0, sy=0;
    if(shake>0){
      sx=(Math.random()-0.5)*shake;
      sy=(Math.random()-0.5)*shake;
      shake*=0.82;
      if(shake<0.7) shake=0;
    }
    ctx.save();
    ctx.translate(sx, sy);

    // zemin
    ctx.strokeStyle = "#00ffff";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(0, canvas.height-40);
    ctx.lineTo(canvas.width, canvas.height-40);
    ctx.stroke();

    // oyuncu
    const px = 70, pw = 26, ph = 34;
    runner.vy += 0.55; // gravity
    runner.y += runner.vy;
    if(runner.y > canvas.height-40 - ph){
      runner.y = canvas.height-40 - ph;
      runner.vy = 0;
      runner.onGround = true;
    }

    ctx.save();
    ctx.shadowColor = "#ff00ff";
    ctx.shadowBlur = 18;
    ctx.fillStyle = "#ff00ff";
    ctx.fillRect(px, runner.y, pw, ph);
    ctx.restore();

    // obstacle spawn
    runner.t++;
    if(runner.t % 70 === 0){
      const h = 20 + Math.random()*28;
      runner.obstacles.push({ x: canvas.width + 10, w: 20 + Math.random()*22, h });
    }

    // obstacles update/draw
    for(const ob of runner.obstacles){
      ob.x -= runner.speed;

      ctx.save();
      ctx.shadowColor = "#00ffff";
      ctx.shadowBlur = 14;
      ctx.fillStyle = "#00ffff";
      ctx.fillRect(ob.x, canvas.height-40 - ob.h, ob.w, ob.h);
      ctx.restore();

      // collision
      const ox = ob.x, oy = canvas.height-40 - ob.h, ow = ob.w, oh = ob.h;
      const hit =
        px < ox+ow && px+pw > ox &&
        runner.y < oy+oh && runner.y+ph > oy;

      if(hit){
        runner.lives -= 1;
        spawnParticles(px+pw, runner.y+ph/2, 32);
        addShake(14);

        // reset obstacle far away
        ob.x = -9999;

        if(runner.lives <= 0){
          runner.lives = 0;
          stopRunner();
          canvas.onclick = null;
          document.getElementById("hud").innerHTML =
            `SKOR: <b>${runner.score}</b> | CAN: <b style="color:var(--bad)">0</b><br><small>Yeniden‚Äôe bas</small>`;
          ctx.restore();
          return;
        }
      }
    }
    runner.obstacles = runner.obstacles.filter(ob => ob.x > -60);

    // score + speed
    runner.score += 1;
    if(runner.score % 120 === 0) runner.speed *= 1.06;

    // g√ºnl√ºk g√∂rev puanƒ± (runner‚Äôda her 30 puanda +1 say)
    if(runner.score % 30 === 0) addScoreToDaily(1);

    updateParticles();
    drawParticles();
    drawActiveAvatar();
    ctx.restore();

    document.getElementById("hud").innerHTML =
      `SKOR: <b>${runner.score}</b> | CAN: <b>${runner.lives}</b><br><small>Tƒ±kla: zƒ±pla</small>`;
  }, 16);
}

function stopRunner(){
  if(runnerInterval){
    clearInterval(runnerInterval);
    runnerInterval = null;
  }
}

/* -------------------- INIT -------------------- */
window.onload = () => {
  hideAll();
  showPanel("login");

  document.getElementById("btn-enter").onclick = enterSite;
  document.getElementById("btn-creator").onclick = openCreator;
  document.getElementById("btn-library").onclick = openLibrary;
  document.getElementById("btn-games").onclick = openGamesHub;

  document.getElementById("nickname").addEventListener("keydown", (e)=>{
    if(e.key === "Enter") enterSite();
  });

  const savedNick = LS.getStr("nickname","");
  if(savedNick) document.getElementById("nickname").value = savedNick;

  updateQuestUI();
  updateUnlockBadge();
  renderCharacter();
};

// global (inline onclick kullandƒ±k, garanti olsun)
window.change = change;
window.saveCurrentCharacter = saveCurrentCharacter;
window.backToMenu = backToMenu;
window.openGame = openGame;
window.openGamesHub = openGamesHub;
window.openOnline = openOnline;

// ADDED globals
window.openOnline = openOnline;
window.createRoom = createRoom;
window.joinRoom = joinRoom;
window.leaveRoom = leaveRoom;
</script>

</body>
</html>


