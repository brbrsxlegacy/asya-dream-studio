<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pixel Master + Online Room + Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
:root{ --neon-pink:#ff00ff; --neon-blue:#00ffff; --good:#00ff66; --bad:#ff3355; }
*{box-sizing:border-box;margin:0;padding:0;}
body,html{
  width:100%;height:100%;
  font-family:'Press Start 2P', cursive;
  background:radial-gradient(circle at 50% 50%,#1a1a2e 0%,#000 100%);
  color:#fff;
  display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
  padding:18px 10px;
}
.hidden{display:none !important;}

@keyframes neonFadeIn{
  0%{opacity:0; filter:drop-shadow(0 0 0px #ff00ff);}
  50%{opacity:.5; filter:drop-shadow(0 0 8px #ff00ff);}
  100%{opacity:1; filter:drop-shadow(0 0 20px #ff00ff);}
}
.neon-show{ animation:neonFadeIn .7s ease forwards; }

h2,p{ text-align:center; line-height:1.45; }
small{ opacity:.85; }

button{
  padding:10px 14px; cursor:pointer;
  font-family:'Press Start 2P';
  border:2px solid var(--neon-pink);
  color:var(--neon-pink);
  background:transparent;
  border-radius:10px;
  transition:.25s;
}
button:hover{ background:var(--neon-pink); color:#000; box-shadow:0 0 15px var(--neon-pink); }
button:disabled{ opacity:.45; cursor:not-allowed; }

input{
  padding:10px 12px;
  border-radius:10px;
  border:2px solid var(--neon-blue);
  background:#0b0b0f;
  color:#fff;
  font-family:'Press Start 2P';
  outline:none;
  width:min(420px, 90vw);
}

.controls{
  display:flex;justify-content:center;align-items:center;
  gap:10px;flex-wrap:wrap;margin-top:12px;
}

.panel{
  width:min(980px, 95vw);
  display:flex;flex-direction:column;align-items:center;
  gap:10px;
}

.badge{
  border:1px solid rgba(255,255,255,.25);
  padding:8px 10px;
  border-radius:12px;
  background:rgba(0,0,0,.35);
  width:min(900px, 95vw);
}
.badge b{ color:var(--neon-blue); }

#character-canvas{
  width:350px;height:480px;
  background:linear-gradient(145deg,#0c0c12,#1a1a2a);
  border:2px solid var(--neon-blue);
  border-radius:16px;
  display:flex;justify-content:center;align-items:center;
  box-shadow:0 0 15px rgba(255,0,255,.35);
  margin:10px 0;
}
#character-canvas svg{ width:100%; height:100%; }

#dolap-list{
  display:flex;flex-wrap:wrap;gap:14px;justify-content:center;
  padding:10px;max-width:95vw;
  overflow-y:auto;max-height:55vh;
}
.character-card{
  background:rgba(0,0,0,0.65);
  padding:10px;border:2px solid var(--neon-blue);
  border-radius:12px;text-align:center;width:190px;
  display:flex;flex-direction:column;align-items:center;gap:10px;
}
.character-card svg{width:92px;height:120px;}
.character-card .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.character-card .row button{ padding:8px 10px; font-size:10px; }

.topbar{
  position:fixed;
  top:10px; left:10px; right:10px;
  display:flex; align-items:center; justify-content:space-between;
  pointer-events:none;
  z-index:999;
}
.net-badge, .room-badge{
  pointer-events:none;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.25);
  background:rgba(0,0,0,.45);
  font-size:10px;
}
.net-badge b{ color:var(--good); }
.net-badge.off b{ color:var(--bad); }
.room-badge b{ color:var(--neon-blue); }

.online-stage{
  width:min(900px, 95vw);
  display:flex; gap:18px; justify-content:center; flex-wrap:wrap;
  margin-top:8px;
}
.avatar-box{
  width:380px; max-width:95vw;
  border:2px solid var(--neon-blue);
  border-radius:16px;
  background:rgba(0,0,0,.35);
  padding:12px;
  display:flex; flex-direction:column; align-items:center; gap:10px;
  box-shadow:0 0 15px rgba(0,255,255,.18);
}
.avatar-box h3{ font-size:12px; }
.avatar-preview{
  width:220px; height:300px;
  border:2px solid var(--neon-pink);
  border-radius:14px;
  display:flex; justify-content:center; align-items:center;
  background:linear-gradient(145deg,#0c0c12,#1a1a2a);
  box-shadow:0 0 15px rgba(255,0,255,.22);
}
.avatar-preview svg{ width:100%; height:100%; }
.sep{
  width:min(900px, 95vw);
  height:1px;
  background:rgba(255,255,255,.12);
  margin:8px 0;
}

/* CHAT */
.chat-wrap{
  width:min(900px,95vw);
  border:1px solid rgba(255,255,255,.2);
  border-radius:14px;
  background:rgba(0,0,0,.35);
  padding:10px;
}
.chat-list{
  height:220px;
  overflow:auto;
  padding:8px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(0,0,0,.25);
}
.msg{
  font-size:10px;
  line-height:1.4;
  margin:6px 0;
  opacity:.95;
  word-break:break-word;
}
.msg b{ color:var(--neon-blue); }
.chat-row{
  display:flex;
  gap:10px;
  margin-top:10px;
  align-items:center;
  justify-content:center;
  flex-wrap:wrap;
}
.chat-row input{ width:min(620px, 95vw); }
</style>
</head>

<body>

<div class="topbar">
  <div class="room-badge" id="roomHud">ROOM: <b>---</b></div>
  <div class="net-badge off" id="netHud">NET: <b>OFF</b> ‚ùå</div>
</div>

<!-- LOGIN -->
<div id="login" class="panel neon-show">
  <p>Takma adƒ±nƒ± gir</p>
  <input id="nickname" placeholder="Takma ad" autocomplete="off" autocapitalize="off" spellcheck="false" />
  <button id="btn-enter">Gƒ∞R</button>
  <p><small>Not: Live Server ile a√ß.</small></p>
</div>

<!-- MENU -->
<div id="menu" class="panel hidden">
  <h2>Merhaba <span id="display-nick"></span>!</h2>
  <div class="controls">
    <button id="btn-library">Dolap</button>
    <button id="btn-creator">Olu≈ütur</button>
    <button id="btn-online" style="border-color:var(--neon-blue);color:var(--neon-blue)">ONLINE MOD</button>
  </div>
</div>

<!-- CREATOR -->
<div id="creator" class="panel hidden">
  <h2>Karakter Olu≈ütur</h2>
  <div class="badge" id="unlock-badge"></div>
  <div id="character-canvas"></div>
  <div class="controls">
    <button id="btn-hair">Sa√ß</button>
    <button id="btn-top">√úst</button>
    <button id="btn-bottom">Alt</button>
    <button id="btn-shoes">Ayakkabƒ±</button>
    <button id="btn-save">Kaydet</button>
    <button id="btn-back1">Geri</button>
  </div>
</div>

<!-- LIBRARY -->
<div id="library" class="panel hidden">
  <h2>Dolap</h2>
  <p><small>AKTƒ∞F yapƒ±nca online odada da o karakter gider.</small></p>
  <div id="dolap-list"></div>
  <div class="controls">
    <button id="btn-back2">Geri</button>
  </div>
</div>

<!-- ONLINE -->
<div id="online" class="panel hidden">
  <h2>ONLINE MOD + CHAT</h2>
  <div class="badge">
    <p>Oda olu≈ütur veya koda gir.</p>
    <p><small>NET ON olunca Auth + DB tamam demek.</small></p>
  </div>

  <div class="controls">
    <button id="btn-create-room" style="border-color:var(--neon-blue);color:var(--neon-blue)">ODA OLU≈ûTUR</button>
    <input id="roomCodeInput" placeholder="5 haneli oda kodu" maxlength="5" />
    <button id="btn-join-room" style="border-color:var(--neon-blue);color:var(--neon-blue)">KATIL</button>
  </div>

  <div class="sep"></div>

  <div class="online-stage">
    <div class="avatar-box">
      <h3>Sen</h3>
      <div class="avatar-preview" id="p1Preview"></div>
      <div class="controls">
        <button id="btn-hair2">Sa√ß</button>
        <button id="btn-top2">√úst</button>
        <button id="btn-bottom2">Alt</button>
        <button id="btn-shoes2">Ayakkabƒ±</button>
        <button id="btn-sync" style="border-color:var(--good);color:var(--good)">SENKRONLA</button>
      </div>
      <p><small>Aktif karakter varsa o gider, yoksa edit√∂r g√∂r√ºn√ºm√º gider.</small></p>
    </div>

    <div class="avatar-box">
      <h3>Diƒüer Ki≈üi</h3>
      <div class="avatar-preview" id="p2Preview"><small>Baƒülanƒ±nca gelecek‚Ä¶</small></div>
      <p><small>Ger√ßek zamanlƒ± g√ºncellenir.</small></p>
    </div>
  </div>

  <div class="sep"></div>

  <div class="chat-wrap">
    <p style="text-align:center"><small>CHAT (oda i√ßindeyken aktif)</small></p>
    <div class="chat-list" id="chatList"></div>
    <div class="chat-row">
      <input id="chatInput" placeholder="Mesaj yaz (Enter)" maxlength="120" />
      <button id="btn-send" style="border-color:var(--neon-blue);color:var(--neon-blue)">G√ñNDER</button>
    </div>
  </div>

  <div class="controls">
    <button id="btn-leave-room" style="border-color:var(--bad);color:var(--bad)">ODADAN √áIK</button>
    <button id="btn-back3">Men√º</button>
  </div>
</div>

<script type="module">
/* -------------------- STORAGE -------------------- */
const LS = {
  get(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch{ return def; } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
  getStr(k, def=""){ return localStorage.getItem(k) ?? def; },
  setStr(k, v){ localStorage.setItem(k, v); }
};
const $ = (id)=>document.getElementById(id);

function hideAll(){
  ["login","menu","creator","library","online"].forEach(id=>$(id).classList.add("hidden"));
}
function showPanel(id){
  const el = $(id);
  el.classList.remove("hidden");
  el.classList.remove("neon-show");
  void el.offsetWidth;
  el.classList.add("neon-show");
}

/* -------------------- DAILY QUEST / UNLOCK -------------------- */
function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function getProgress(){
  const p = LS.get("dailyProgress", null);
  const t = todayKey();
  if(!p || p.day !== t){
    const fresh = { day:t, score:0, completed:false, claimed:false };
    LS.set("dailyProgress", fresh);
    return fresh;
  }
  return p;
}
function saveProgress(p){ LS.set("dailyProgress", p); }
function claimReward(){
  const p = getProgress();
  if(!p.completed || p.claimed) return;
  p.claimed = true;
  saveProgress(p);
  LS.set("neonPackUnlocked", true);
  updateUnlockBadge();
  alert("NEON PACK a√ßƒ±ldƒ±!");
}

/* -------------------- CHARACTER -------------------- */
const bodyBase = `
<rect x="35" y="30" width="30" height="30" fill="#ffdbac"/>
<rect x="40" y="60" width="20" height="40" fill="#ffdbac"/>
<rect x="40" y="100" width="9" height="40" fill="#ffdbac"/>
<rect x="51" y="100" width="9" height="40" fill="#ffdbac"/>
`;

const baseAssets = {
  hair:[
    `<rect x="35" y="25" width="30" height="10" fill="#4d2600"/>`,
    `<rect x="32" y="20" width="36" height="20" fill="#ffd700"/>`,
    `<rect x="30" y="18" width="40" height="22" fill="#00ffff"/>`,
    `<rect x="35" y="25" width="30" height="10" fill="#ff00ff"/>`,
    `<rect x="32" y="20" width="36" height="20" fill="#ff4500"/>`,
    `<rect x="30" y="18" width="40" height="22" fill="#00ff00"/>`,
    `<rect x="34" y="23" width="32" height="12" fill="#1e90ff"/>`,
    `<rect x="33" y="21" width="34" height="14" fill="#ff1493"/>`,
    `<rect x="35" y="22" width="30" height="15" fill="#ffa500"/>`,
    `<rect x="31" y="19" width="38" height="18" fill="#adff2f"/>`
  ],
  top:[
    `<rect x="40" y="60" width="20" height="35" fill="#ff0055"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#222"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#00ff00"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ff00ff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#1e90ff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ffa500"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#00ffff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#adff2f"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ff4500"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ff1493"/>`
  ],
  bottom:[
    `<rect x="40" y="95" width="9" height="45" fill="#2b2b80"/><rect x="51" y="95" width="9" height="45" fill="#2b2b80"/>`,
    `<rect x="40" y="95" width="20" height="15" fill="#555"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ff00ff"/><rect x="51" y="95" width="9" height="45" fill="#ff00ff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#00ffff"/><rect x="51" y="95" width="9" height="45" fill="#00ffff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ffa500"/><rect x="51" y="95" width="9" height="45" fill="#ffa500"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ff1493"/><rect x="51" y="95" width="9" height="45" fill="#ff1493"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#1e90ff"/><rect x="51" y="95" width="9" height="45" fill="#1e90ff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#00ff00"/><rect x="51" y="95" width="9" height="45" fill="#00ff00"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ff4500"/><rect x="51" y="95" width="9" height="45" fill="#ff4500"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#adff2f"/><rect x="51" y="95" width="9" height="45" fill="#adff2f"/>`
  ],
  shoes:[
    `<rect x="38" y="140" width="14" height="6" fill="#000"/><rect x="52" y="140" width="14" height="6" fill="#000"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#ff3355"/><rect x="52" y="140" width="14" height="6" fill="#ff3355"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#1e90ff"/><rect x="52" y="140" width="14" height="6" fill="#1e90ff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#00ff66"/><rect x="52" y="140" width="14" height="6" fill="#00ff66"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#ff00ff"/><rect x="52" y="140" width="14" height="6" fill="#ff00ff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#00ffff"/><rect x="52" y="140" width="14" height="6" fill="#00ffff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#ffd700"/><rect x="52" y="140" width="14" height="6" fill="#ffd700"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#555"/><rect x="52" y="140" width="14" height="6" fill="#555"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#fff"/><rect x="52" y="140" width="14" height="6" fill="#fff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#8b4513"/><rect x="52" y="140" width="14" height="6" fill="#8b4513"/>`
  ]
};

const neonPack = {
  hair:[
    `<rect x="29" y="18" width="42" height="20" fill="#9b5cff"/><rect x="31" y="22" width="38" height="6" fill="#00ffff"/>`,
    `<rect x="31" y="18" width="38" height="22" fill="#00ff66"/>`,
    `<rect x="30" y="20" width="40" height="18" fill="#ff3355"/>`,
    `<rect x="32" y="18" width="36" height="22" fill="#ffffff"/><rect x="33" y="22" width="34" height="4" fill="#ff00ff"/>`,
    `<rect x="30" y="18" width="40" height="22" fill="#222"/><rect x="30" y="18" width="40" height="4" fill="#00ffff"/>`
  ],
  top:[
    `<rect x="40" y="60" width="20" height="35" fill="#9b5cff"/><rect x="40" y="74" width="20" height="4" fill="#00ffff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#00ff66"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ff3355"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#fff"/><rect x="40" y="66" width="20" height="4" fill="#ff00ff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#111"/><rect x="40" y="60" width="20" height="3" fill="#00ffff"/>`
  ],
  bottom:[
    `<rect x="40" y="95" width="9" height="45" fill="#9b5cff"/><rect x="51" y="95" width="9" height="45" fill="#9b5cff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#00ff66"/><rect x="51" y="95" width="9" height="45" fill="#00ff66"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ff3355"/><rect x="51" y="95" width="9" height="45" fill="#ff3355"/>`,
    `<rect x="40" y="95" width="20" height="15" fill="#fff"/><rect x="40" y="110" width="20" height="3" fill="#ff00ff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#111"/><rect x="51" y="95" width="9" height="45" fill="#111"/><rect x="40" y="95" width="20" height="3" fill="#00ffff"/>`
  ],
  shoes:[
    `<rect x="38" y="140" width="14" height="6" fill="#9b5cff"/><rect x="52" y="140" width="14" height="6" fill="#9b5cff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#00ff66"/><rect x="52" y="140" width="14" height="6" fill="#00ff66"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#ff3355"/><rect x="52" y="140" width="14" height="6" fill="#ff3355"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#fff"/><rect x="52" y="140" width="14" height="6" fill="#fff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#111"/><rect x="52" y="140" width="14" height="6" fill="#111"/><rect x="38" y="140" width="28" height="2" fill="#00ffff"/>`
  ]
};

function neonUnlocked(){ return !!LS.get("neonPackUnlocked", false); }
function getAssetList(cat){
  const base = baseAssets[cat];
  return neonUnlocked() ? base.concat(neonPack[cat]) : base;
}
let currentIndices = { hair:0, top:0, bottom:0, shoes:0 };

function makeSvgFromIndices(indices){
  const hairList = getAssetList("hair");
  const topList = getAssetList("top");
  const bottomList = getAssetList("bottom");
  const shoesList = getAssetList("shoes");

  const h = ((indices.hair % hairList.length)+hairList.length)%hairList.length;
  const t = ((indices.top % topList.length)+topList.length)%topList.length;
  const b = ((indices.bottom % bottomList.length)+bottomList.length)%bottomList.length;
  const s = ((indices.shoes % shoesList.length)+shoesList.length)%shoesList.length;

  return `
  <svg viewBox="0 0 100 160" xmlns="http://www.w3.org/2000/svg">
    ${bodyBase}
    ${hairList[h]}
    ${topList[t]}
    ${bottomList[b]}
    ${shoesList[s]}
  </svg>`;
}

function renderCharacter(){
  $("character-canvas").innerHTML = makeSvgFromIndices(currentIndices);
}
function updateUnlockBadge(){
  const b = $("unlock-badge");
  if(neonUnlocked()){
    b.innerHTML = `Neon Pack: <b>A√áIK</b> ‚úÖ`;
  }else{
    const p = getProgress();
    b.innerHTML = `Neon Pack: <b>Kƒ∞Lƒ∞TLƒ∞</b> üîí | G√ºnl√ºk: <b>${p.score}/20</b> <button id="claimBtn" style="margin-left:10px;border-color:var(--good);color:var(--good)">√ñD√úL</button>`;
    const btn = $("claimBtn");
    if(btn) btn.onclick = claimReward;
  }
}
function change(cat){
  const list = getAssetList(cat);
  currentIndices[cat] = (currentIndices[cat] + 1) % list.length;
  renderCharacter();
  if(roomState.inRoom) pushMyState().catch(()=>{});
}
function getMyDisplaySvg(){
  const active = LS.getStr("activeCharacterSVG","");
  return active || makeSvgFromIndices(currentIndices);
}

/* -------------------- LOGIN/MENU -------------------- */
function enterSite(){
  const nick = $("nickname").value.trim();
  if(!nick) return alert("Takma ad bo≈ü olamaz!");
  LS.setStr("nickname", nick);
  $("display-nick").textContent = nick;
  hideAll(); showPanel("menu");
}
function openCreator(){
  hideAll(); showPanel("creator");
  updateUnlockBadge();
  renderCharacter();
}
function openLibrary(){
  hideAll(); showPanel("library");
  loadLibrary();
}
function openOnline(){
  hideAll(); showPanel("online");
  renderOnlinePreviews();
  refreshChatUI();
}

/* -------------------- DOLAP (HATASIZ) -------------------- */
function saveCurrentCharacter(){
  const nick = LS.getStr("nickname","anon");
  const svg = makeSvgFromIndices(currentIndices);
  const saved = LS.get("savedCharacters", []);
  saved.push({ nick, svg, ts: Date.now() });
  LS.set("savedCharacters", saved);
  alert("Karakter kaydedildi!");
}
function loadLibrary(){
  const nick = LS.getStr("nickname","");
  const container = $("dolap-list");
  container.innerHTML = "";

  const saved = LS.get("savedCharacters", []);
  const my = saved.filter(x => x.nick === nick).slice().reverse();

  if(my.length === 0){
    container.innerHTML = "<p>Hen√ºz karakter yok.</p>";
    return;
  }

  for(const c of my){
    const card = document.createElement("div");
    card.className = "character-card";
    card.innerHTML = `
      <div class="preview">${c.svg}</div>
      <div class="row">
        <button class="btnActive" style="border-color:var(--neon-blue);color:var(--neon-blue)">AKTƒ∞F</button>
        <button class="btnDel" style="border-color:var(--bad);color:var(--bad)">Sƒ∞L</button>
      </div>
      <small>${new Date(c.ts).toLocaleString()}</small>
    `;

    card.querySelector(".btnActive").onclick = (ev) => {
      ev.stopPropagation();
      LS.setStr("activeCharacterSVG", c.svg);
      alert("Aktif karakter ayarlandƒ±!");
    };

    card.querySelector(".btnDel").onclick = (ev) => {
      ev.stopPropagation();
      const all = LS.get("savedCharacters", []);
      const kept = all.filter(x => !(x.nick===c.nick && x.ts===c.ts));
      LS.set("savedCharacters", kept);
      loadLibrary();
    };

    container.appendChild(card);
  }
}

/* -------------------- FIREBASE ONLINE + CHAT -------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getDatabase, ref, set, update, onValue, get, remove, onDisconnect,
  push, onChildAdded, query, limitToLast
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
import {
  getAuth, signInAnonymously, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyABqkhpL1SMRzRJ9GQLjjZE2IryqpAvMPw",
  authDomain: "pixelroom-ae218.firebaseapp.com",
  databaseURL: "https://pixelroom-ae218-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "pixelroom-ae218",
  storageBucket: "pixelroom-ae218.firebasestorage.app",
  messagingSenderId: "720297722320",
  appId: "1:720297722320:web:c815edae99d1efa7ff39d5",
  measurementId: "G-HD8901B19M"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const netHud = $("netHud");
const roomHud = $("roomHud");

const roomState = {
  uid: null,
  inRoom: false,
  roomId: null,
  role: null,   // "p1" | "p2"
  unsubRoom: null,
  unsubChat: null,
  connected: false
};

function setNetUI(on){
  if(on){
    netHud.classList.remove("off");
    netHud.innerHTML = `NET: <b>ON</b> ‚úÖ`;
  }else{
    netHud.classList.add("off");
    netHud.innerHTML = `NET: <b>OFF</b> ‚ùå`;
  }
}
function updateRoomUI(){
  roomHud.innerHTML = `ROOM: <b>${roomState.roomId ?? "---"}</b>`;
}
function randomRoomCode(){
  return String(Math.floor(10000 + Math.random()*90000));
}

async function ensureAuth(){
  if(roomState.uid) return roomState.uid;
  await signInAnonymously(auth);
  return new Promise((resolve, reject) => {
    const off = onAuthStateChanged(auth, (u)=>{
      if(u){
        roomState.uid = u.uid;
        off();
        resolve(u.uid);
      }
    });
    setTimeout(()=>reject(new Error("Auth timeout")), 7000);
  });
}

function renderOnlinePreviews(){
  $("p1Preview").innerHTML = getMyDisplaySvg();
  if(!roomState.inRoom){
    $("p2Preview").innerHTML = "<small>Baƒülanƒ±nca gelecek‚Ä¶</small>";
  }
}

async function createRoom(){
  await ensureAuth();
  const roomId = randomRoomCode();
  const roomRef = ref(db, `rooms/${roomId}`);
  const nick = LS.getStr("nickname","anon");

  await set(roomRef, {
    createdAt: Date.now(),
    p1: { uid: roomState.uid, nick, svg: getMyDisplaySvg(), ts: Date.now() }
  });

  roomState.inRoom = true;
  roomState.roomId = roomId;
  roomState.role = "p1";
  updateRoomUI();

  onDisconnect(roomRef).remove().catch(()=>{});
  listenRoom(roomId);

  alert("Oda kuruldu: " + roomId);
  renderOnlinePreviews();
  refreshChatUI();
}

async function joinRoom(roomId){
  await ensureAuth();
  roomId = String(roomId||"").trim();
  if(!/^\d{5}$/.test(roomId)) return alert("Oda kodu 5 haneli olmalƒ±!");

  const roomRef = ref(db, `rooms/${roomId}`);
  const snap = await get(roomRef);
  if(!snap.exists()) return alert("Oda bulunamadƒ±!");

  const data = snap.val();
  if(!data.p1) return alert("Oda bozuk (p1 yok).");
  if(data.p2 && data.p2.uid && data.p2.uid !== roomState.uid) return alert("Oda dolu!");

  const nick = LS.getStr("nickname","anon");
  await update(roomRef, {
    p2: { uid: roomState.uid, nick, svg: getMyDisplaySvg(), ts: Date.now() }
  });

  roomState.inRoom = true;
  roomState.roomId = roomId;
  roomState.role = "p2";
  updateRoomUI();

  const p2Ref = ref(db, `rooms/${roomId}/p2`);
  onDisconnect(p2Ref).remove().catch(()=>{});

  listenRoom(roomId);
  alert("Odaya girdin: " + roomId);
  renderOnlinePreviews();
  refreshChatUI();
}

function listenRoom(roomId){
  if(roomState.unsubRoom) roomState.unsubRoom();
  const roomRef = ref(db, `rooms/${roomId}`);

  const unsubscribe = onValue(roomRef, (snap)=>{
    if(!snap.exists()){
      roomState.inRoom = false;
      roomState.roomId = null;
      roomState.role = null;
      updateRoomUI();
      $("p2Preview").innerHTML = "<small>Oda kapandƒ±.</small>";
      stopChatListen();
      refreshChatUI();
      return;
    }
    const data = snap.val();

    if(roomState.role === "p1"){
      $("p1Preview").innerHTML = getMyDisplaySvg();
      $("p2Preview").innerHTML = (data.p2 && data.p2.svg) ? data.p2.svg : "<small>Arkada≈ü bekleniyor‚Ä¶</small>";
    }else if(roomState.role === "p2"){
      $("p1Preview").innerHTML = getMyDisplaySvg();
      $("p2Preview").innerHTML = (data.p1 && data.p1.svg) ? data.p1.svg : "<small>p1 yok‚Ä¶</small>";
    }
    updateRoomUI();
  });

  roomState.unsubRoom = unsubscribe;
}

async function pushMyState(){
  if(!roomState.inRoom || !roomState.roomId || !roomState.role) return;
  const nick = LS.getStr("nickname","anon");
  const svg = getMyDisplaySvg();
  const meRef = ref(db, `rooms/${roomState.roomId}/${roomState.role}`);
  await update(meRef, { uid: roomState.uid, nick, svg, ts: Date.now() });
  $("p1Preview").innerHTML = svg;
}

async function leaveRoom(){
  if(!roomState.inRoom || !roomState.roomId) return;

  const roomId = roomState.roomId;
  const role = roomState.role;

  try{
    if(role === "p1") await remove(ref(db, `rooms/${roomId}`));
    else await remove(ref(db, `rooms/${roomId}/p2`));
  }catch(e){}

  if(roomState.unsubRoom) roomState.unsubRoom();
  roomState.unsubRoom = null;

  roomState.inRoom = false;
  roomState.roomId = null;
  roomState.role = null;
  updateRoomUI();

  stopChatListen();
  refreshChatUI();
  renderOnlinePreviews();
  alert("Odadan √ßƒ±ktƒ±n.");
}

/* DB CONNECTED -> NET */
onValue(ref(db, ".info/connected"), (snap)=>{
  roomState.connected = !!snap.val();
  setNetUI(roomState.connected && !!roomState.uid);
});

/* Auth state */
onAuthStateChanged(auth, (u)=>{
  roomState.uid = u ? u.uid : null;
  setNetUI(roomState.connected && !!roomState.uid);
});

/* -------------------- CHAT -------------------- */
function stopChatListen(){
  if(roomState.unsubChat) roomState.unsubChat();
  roomState.unsubChat = null;
}
function addMsgToUI(nick, text){
  const div = document.createElement("div");
  div.className = "msg";
  div.innerHTML = `<b>${escapeHtml(nick)}</b>: ${escapeHtml(text)}`;
  $("chatList").appendChild(div);
  $("chatList").scrollTop = $("chatList").scrollHeight;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

function refreshChatUI(){
  $("chatList").innerHTML = "";
  if(!roomState.inRoom || !roomState.roomId){
    $("chatList").innerHTML = `<div class="msg"><small>Chat i√ßin odaya girmen lazƒ±m.</small></div>`;
    return;
  }
  $("chatList").innerHTML = `<div class="msg"><small>Chat hazƒ±r. Mesaj yaz.</small></div>`;
  startChatListen();
}

function startChatListen(){
  stopChatListen();
  if(!roomState.inRoom || !roomState.roomId) return;

  const chatRef = ref(db, `rooms/${roomState.roomId}/chat`);
  const q = query(chatRef, limitToLast(40));

  $("chatList").innerHTML = ""; // temizle
  const unsubscribe = onChildAdded(q, (snap)=>{
    const m = snap.val();
    if(!m || !m.text) return;
    addMsgToUI(m.nick || "anon", m.text);
  });

  roomState.unsubChat = unsubscribe;
}

async function sendChat(){
  if(!roomState.inRoom || !roomState.roomId) return alert("√ñnce odaya gir!");
  const txt = $("chatInput").value.trim();
  if(!txt) return;

  await ensureAuth();

  const nick = LS.getStr("nickname","anon");
  const chatRef = ref(db, `rooms/${roomState.roomId}/chat`);
  await push(chatRef, { uid: roomState.uid, nick, text: txt, ts: Date.now() });

  $("chatInput").value = "";
}

/* -------------------- INIT UI -------------------- */
function backToMenu(){
  hideAll();
  $("display-nick").textContent = LS.getStr("nickname","");
  showPanel("menu");
}

function init(){
  hideAll(); showPanel("login");

  // login
  $("btn-enter").onclick = enterSite;
  $("nickname").addEventListener("keydown", (e)=>{ if(e.key==="Enter") enterSite(); });

  const savedNick = LS.getStr("nickname","");
  if(savedNick) $("nickname").value = savedNick;
  $("nickname").focus();

  // menu
  $("btn-creator").onclick = openCreator;
  $("btn-library").onclick = openLibrary;
  $("btn-online").onclick = openOnline;

  // creator
  $("btn-hair").onclick = ()=>change("hair");
  $("btn-top").onclick = ()=>change("top");
  $("btn-bottom").onclick = ()=>change("bottom");
  $("btn-shoes").onclick = ()=>change("shoes");
  $("btn-save").onclick = saveCurrentCharacter;
  $("btn-back1").onclick = backToMenu;

  // library
  $("btn-back2").onclick = backToMenu;

  // online
  $("btn-back3").onclick = backToMenu;
  $("btn-create-room").onclick = createRoom;
  $("btn-join-room").onclick = ()=>joinRoom($("roomCodeInput").value);
  $("btn-leave-room").onclick = leaveRoom;
  $("btn-sync").onclick = pushMyState;

  $("btn-hair2").onclick = ()=>change("hair");
  $("btn-top2").onclick = ()=>change("top");
  $("btn-bottom2").onclick = ()=>change("bottom");
  $("btn-shoes2").onclick = ()=>change("shoes");

  $("btn-send").onclick = sendChat;
  $("chatInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendChat(); });

  updateRoomUI();
  updateUnlockBadge();
  renderCharacter();
  renderOnlinePreviews();

  // auth dene (NET ON i√ßin)
  ensureAuth().catch((e)=>{
    console.log("AUTH FAIL:", e);
    alert("Firebase Auth √ßalƒ±≈ümadƒ±: " + (e?.message || e));
  });
}

if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
else init();
</script>

</body>
</html>

