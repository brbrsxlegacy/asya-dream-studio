<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pixel Master + Mini Oyun</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
:root{ --neon-pink:#ff00ff; --neon-blue:#00ffff; --good:#00ff66; --bad:#ff3355; }
*{box-sizing:border-box;margin:0;padding:0;}
body,html{
  width:100%;height:100%;
  font-family:'Press Start 2P', cursive;
  background:radial-gradient(circle at 50% 50%,#1a1a2e 0%,#000 100%);
  color:#fff;
  display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
  padding:18px 10px;
}
.hidden{display:none !important;}
@keyframes neonFadeIn{
  0%{opacity:0; filter:drop-shadow(0 0 0px #ff00ff);}
  50%{opacity:.5; filter:drop-shadow(0 0 8px #ff00ff);}
  100%{opacity:1; filter:drop-shadow(0 0 20px #ff00ff);}
}
.neon-show{ animation:neonFadeIn .7s ease forwards; }
h2,p{ text-align:center; line-height:1.45; }
small{ opacity:.8; }

button{
  padding:10px 14px; cursor:pointer;
  font-family:'Press Start 2P';
  border:2px solid var(--neon-pink);
  color:var(--neon-pink);
  background:transparent;
  border-radius:10px;
  transition:.25s;
}
button:hover{ background:var(--neon-pink); color:#000; box-shadow:0 0 15px var(--neon-pink); }
button:disabled{ opacity:.5; cursor:not-allowed; }

input{
  padding:10px 12px;
  border-radius:10px;
  border:2px solid var(--neon-blue);
  background:#0b0b0f;
  color:#fff;
  font-family:'Press Start 2P';
  outline:none;
  width:min(420px, 90vw);
}
.controls{
  display:flex;justify-content:center;align-items:center;
  gap:10px;flex-wrap:wrap;margin-top:12px;
}
.panel{
  width:min(980px, 95vw);
  display:flex;flex-direction:column;align-items:center;
  gap:10px;
}
#character-canvas{
  width:350px;height:480px;
  background:linear-gradient(145deg,#0c0c12,#1a1a2a);
  border:2px solid var(--neon-blue);
  border-radius:16px;
  display:flex;justify-content:center;align-items:center;
  box-shadow:0 0 15px rgba(255,0,255,.35);
  margin:10px 0;
}
#dolap-list{
  display:flex;flex-wrap:wrap;gap:14px;justify-content:center;
  padding:10px;max-width:95vw;
  overflow-y:auto;max-height:55vh;
}
.character-card{
  background:rgba(0,0,0,0.65);
  padding:10px;border:2px solid var(--neon-blue);
  border-radius:12px;text-align:center;width:160px;
  display:flex;flex-direction:column;align-items:center;gap:8px;
}
.character-card svg{width:92px;height:120px;}
.character-card .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}

.badge{
  border:1px solid rgba(255,255,255,.25);
  padding:8px 10px;
  border-radius:12px;
  background:rgba(0,0,0,.35);
  width:min(820px, 95vw);
}
.badge b{ color:var(--neon-blue); }

canvas{
  border:2px solid var(--neon-pink);
  border-radius:12px;
  background:#0a0a0f;
  box-shadow:0 0 15px rgba(255,0,255,.28);
  touch-action: manipulation;
}
.grid3{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap:10px;
  width:min(820px, 95vw);
}
@media (max-width:900px){ .grid3{ grid-template-columns: 1fr; } }
.game-btn{
  padding:14px 12px;
  border:2px solid var(--neon-blue);
  color:var(--neon-blue);
}
.game-btn:hover{ background:var(--neon-blue); color:#000; box-shadow:0 0 15px var(--neon-blue); }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="panel neon-show">
  <p>Takma adƒ±nƒ± gir</p>
  <input id="nickname" placeholder="Takma ad">
  <button id="btn-enter">Gƒ∞R</button>
</div>

<!-- MENU -->
<div id="menu" class="panel hidden">
  <h2>Merhaba <span id="display-nick"></span>!</h2>
  <div class="controls">
    <button id="btn-library">Dolap</button>
    <button id="btn-creator">Olu≈ütur</button>
    <button id="btn-games">OYUNLAR</button>
    <button id="btn-online" onclick="openOnline()">ONLINE MOD</button>
  </div>
</div>

<!-- CREATOR -->
<div id="creator" class="panel hidden">
  <h2>Karakter Olu≈ütur</h2>
  <div class="badge" id="unlock-badge"></div>
  <div id="character-canvas"></div>
  <div class="controls">
    <button onclick="change('hair')">Sa√ß</button>
    <button onclick="change('top')">√úst</button>
    <button onclick="change('bottom')">Alt</button>
    <button onclick="change('shoes')">Ayakkabƒ±</button>
    <button onclick="saveCurrentCharacter()">Kaydet</button>
    <button onclick="backToMenu()">Geri</button>
  </div>
</div>

<!-- LIBRARY -->
<div id="library" class="panel hidden">
  <h2>Dolap</h2>
  <p><small>Karakter kartƒ±na tƒ±kla: ‚Äúaktif karakter‚Äù yapar (oyunlarda k√∂≈üede √ßƒ±kar).</small></p>
  <div id="dolap-list"></div>
  <div class="controls">
    <button onclick="backToMenu()">Geri</button>
  </div>
</div>

<!-- ONLINE MOD -->
<div id="online" class="panel hidden">
  <h2>Online Mod</h2>
  <button onclick="createRoom()">Oda Olu≈ütur</button>
  <p>‚Äî veya ‚Äî</p>
  <input id="joinCode" placeholder="5 haneli kod">
  <button onclick="joinRoom()">Odaya Gir</button>
  <button onclick="backToMenu()">Geri</button>
</div>

<!-- ROOM -->
<div id="room" class="panel hidden">
  <div id="room-code" style="position:fixed;top:10px;left:10px;color:#00ffff">ODA: -----</div>

  <div style="display:flex;gap:40px;flex-wrap:wrap;justify-content:center;width:min(900px,95vw)">
    <div>
      <h2>Sen</h2>
      <div id="my-character"></div>
      <div class="controls">
        <button onclick="change('hair')">Sa√ß</button>
        <button onclick="change('top')">√úst</button>
        <button onclick="change('bottom')">Alt</button>
        <button onclick="change('shoes')">Ayakkabƒ±</button>
      </div>
    </div>

    <div>
      <h2>Arkada≈ü</h2>
      <div id="friend-character"></div>
      <p><small>Kodla girince burada g√∂r√ºnecek.</small></p>
    </div>
  </div>

  <div class="controls">
    <button onclick="leaveRoom()">Geri</button>
  </div>
</div>

<!-- GAMES HUB -->
<div id="games" class="panel hidden">
  <h2>OYUNLAR</h2>
  <div class="badge" id="quest-box"></div>

  <div class="grid3">
    <button class="game-btn" onclick="openGame('bounce')">Neon Bounce</button>
    <button class="game-btn" onclick="openGame('reaction')">Reaction Rush</button>
    <button class="game-btn" onclick="openGame('runner')">Neon Runner</button>
  </div>

  <div class="controls">
    <button onclick="backToMenu()">Geri</button>
  </div>
</div>

<!-- GAME SCREEN -->
<div id="game" class="panel hidden">
  <h2 id="game-title">Oyun</h2>
  <div class="badge" id="hud"></div>
  <canvas id="game-canvas" width="360" height="520"></canvas>
  <div class="controls">
    <button id="btn-restart">Yeniden</button>
    <button onclick="openGamesHub()">Oyunlar</button>
    <button onclick="backToMenu()">Men√º</button>
  </div>
</div>

<script>
/* -------------------- STORAGE HELPERS -------------------- */
const LS = {
  get(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch{ return def; } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
  getStr(k, def=""){ return localStorage.getItem(k) ?? def; },
  setStr(k, v){ localStorage.setItem(k, v); }
};

function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

/* -------------------- DAILY QUEST / UNLOCK -------------------- */
function getProgress(){
  const p = LS.get("dailyProgress", null);
  const t = todayKey();
  if(!p || p.day !== t){
    const fresh = { day:t, score:0, completed:false, claimed:false };
    LS.set("dailyProgress", fresh);
    return fresh;
  }
  return p;
}
function saveProgress(p){ LS.set("dailyProgress", p); }
function addScoreToDaily(amount){
  const p = getProgress();
  if(p.completed) return;
  p.score = Math.max(0, (p.score||0) + amount);
  if(p.score >= 20){
    p.score = 20;
    p.completed = true;
  }
  saveProgress(p);
  updateQuestUI();
  updateUnlockBadge();
}
function claimReward(){
  const p = getProgress();
  if(!p.completed || p.claimed) return;
  p.claimed = true;
  saveProgress(p);
  LS.set("neonPackUnlocked", true);
  updateQuestUI();
  updateUnlockBadge();
  alert("NEON PACK a√ßƒ±ldƒ±! (ekstra sa√ß/√ºst/alt/ayakkabƒ±)");
}

/* -------------------- CHARACTER ASSETS -------------------- */
const bodyBase = `
<rect x="35" y="30" width="30" height="30" fill="#ffdbac"/>
<rect x="40" y="60" width="20" height="40" fill="#ffdbac"/>
<rect x="40" y="100" width="9" height="40" fill="#ffdbac"/>
<rect x="51" y="100" width="9" height="40" fill="#ffdbac"/>
`;

const baseAssets = {
  hair:[
    `<rect x="35" y="25" width="30" height="10" fill="#4d2600"/>`,
    `<rect x="32" y="20" width="36" height="20" fill="#ffd700"/>`,
    `<rect x="30" y="18" width="40" height="22" fill="#00ffff"/>`,
    `<rect x="35" y="25" width="30" height="10" fill="#ff00ff"/>`,
    `<rect x="32" y="20" width="36" height="20" fill="#ff4500"/>`,
    `<rect x="30" y="18" width="40" height="22" fill="#00ff00"/>`,
    `<rect x="34" y="23" width="32" height="12" fill="#1e90ff"/>`,
    `<rect x="33" y="21" width="34" height="14" fill="#ff1493"/>`,
    `<rect x="35" y="22" width="30" height="15" fill="#ffa500"/>`,
    `<rect x="31" y="19" width="38" height="18" fill="#adff2f"/>`
  ],
  top:[
    `<rect x="40" y="60" width="20" height="35" fill="#ff0055"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#222"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#00ff00"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ff00ff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#1e90ff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ffa500"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#00ffff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#adff2f"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ff4500"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ff1493"/>`
  ],
  bottom:[
    `<rect x="40" y="95" width="9" height="45" fill="#2b2b80"/><rect x="51" y="95" width="9" height="45" fill="#2b2b80"/>`,
    `<rect x="40" y="95" width="20" height="15" fill="#555"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ff00ff"/><rect x="51" y="95" width="9" height="45" fill="#ff00ff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#00ffff"/><rect x="51" y="95" width="9" height="45" fill="#00ffff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ffa500"/><rect x="51" y="95" width="9" height="45" fill="#ffa500"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ff1493"/><rect x="51" y="95" width="9" height="45" fill="#ff1493"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#1e90ff"/><rect x="51" y="95" width="9" height="45" fill="#1e90ff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#00ff00"/><rect x="51" y="95" width="9" height="45" fill="#00ff00"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ff4500"/><rect x="51" y="95" width="9" height="45" fill="#ff4500"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#adff2f"/><rect x="51" y="95" width="9" height="45" fill="#adff2f"/>`
  ],
  shoes:[
    `<rect x="38" y="140" width="14" height="6" fill="#000"/><rect x="52" y="140" width="14" height="6" fill="#000"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="red"/><rect x="52" y="140" width="14" height="6" fill="red"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="blue"/><rect x="52" y="140" width="14" height="6" fill="blue"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="green"/><rect x="52" y="140" width="14" height="6" fill="green"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#ff00ff"/><rect x="52" y="140" width="14" height="6" fill="#ff00ff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#00ffff"/><rect x="52" y="140" width="14" height="6" fill="#00ffff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#ffd700"/><rect x="52" y="140" width="14" height="6" fill="#ffd700"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#555"/><rect x="52" y="140" width="14" height="6" fill="#555"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#fff"/><rect x="52" y="140" width="14" height="6" fill="#fff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#8b4513"/><rect x="52" y="140" width="14" height="6" fill="#8b4513"/>`
  ]
};

const neonPack = { hair:[], top:[], bottom:[], shoes:[] }; // (senin packi eklemek istersen buraya koy)

function neonUnlocked(){ return !!LS.get("neonPackUnlocked", false); }
function getAssetList(cat){
  const base = baseAssets[cat];
  const extra = neonPack[cat] || [];
  return neonUnlocked() ? base.concat(extra) : base;
}

let currentIndices = { hair:0, top:0, bottom:0, shoes:0 };

function renderCharacter(){
  const canvasEl = document.getElementById('character-canvas');
  const hairList = getAssetList("hair");
  const topList = getAssetList("top");
  const bottomList = getAssetList("bottom");
  const shoesList = getAssetList("shoes");

  currentIndices.hair = (currentIndices.hair % hairList.length + hairList.length) % hairList.length;
  currentIndices.top = (currentIndices.top % topList.length + topList.length) % topList.length;
  currentIndices.bottom = (currentIndices.bottom % bottomList.length + bottomList.length) % bottomList.length;
  currentIndices.shoes = (currentIndices.shoes % shoesList.length + shoesList.length) % shoesList.length;

  if(!canvasEl) return;
  canvasEl.innerHTML = `
    <svg viewBox="0 0 100 160" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%">
      ${bodyBase}
      ${hairList[currentIndices.hair]}
      ${topList[currentIndices.top]}
      ${bottomList[currentIndices.bottom]}
      ${shoesList[currentIndices.shoes]}
    </svg>
  `;
}

/* -------------------- FIREBASE SAFE INIT -------------------- */
let firebaseReady = false;
let rtdb = null;

const firebaseCfg = {
  apiKey: "AIzaSyABqkhpL1SMRzRJ9GQLjjZE2IryqpAvMPw",
  authDomain: "pixelroom-ae218.firebaseapp.com",
  projectId: "pixelroom-ae218",
  storageBucket: "pixelroom-ae218.firebasestorage.app",
  messagingSenderId: "720297722320",
  appId: "1:720297722320:web:c815edae99d1efa7ff39d5",
  measurementId: "G-HD8901B19M",
  // b√∂lge uyarƒ±sƒ±nƒ± √ß√∂zen URL:
  databaseURL: "https://pixelroom-ae218-default-rtdb.europe-west1.firebasedatabase.app"
};

function setOnlineBtnState(){
  const btn = document.getElementById("btn-online");
  if(!btn) return;
  if(firebaseReady && navigator.onLine){
    btn.disabled = false;
    btn.textContent = "ONLINE MOD";
  }else{
    btn.disabled = true;
    btn.textContent = "ONLINE (NET YOK)";
  }
}

function initFirebaseSafe(){
  if(!navigator.onLine){
    firebaseReady = false;
    setOnlineBtnState();
    return;
  }
  if(!window.firebase){
    firebaseReady = false;
    setOnlineBtnState();
    console.warn("Firebase scriptleri y√ºklenmedi (CDN).");
    return;
  }

  try{
    if(!firebase.apps.length) firebase.initializeApp(firebaseCfg);

    firebase.auth().signInAnonymously()
      .then(()=>{
        rtdb = firebase.database();
        firebaseReady = true;
        setOnlineBtnState();
      })
      .catch(err=>{
        console.error("Auth hata:", err);
        firebaseReady = false;
        setOnlineBtnState();
      });
  }catch(err){
    console.error("Firebase init hata:", err);
    firebaseReady = false;
    setOnlineBtnState();
  }
}

window.addEventListener("online", ()=>{ initFirebaseSafe(); });
window.addEventListener("offline", ()=>{ firebaseReady = false; setOnlineBtnState(); });

/* -------------------- ONLINE ROOM -------------------- */
let roomCode = null;
let slot = null;

function generateRoomCode(){
  return String(Math.floor(10000 + Math.random()*90000));
}

function drawCharacterFromIndices(indices, targetId){
  const target = document.getElementById(targetId);
  if(!target) return;

  if(!indices){
    target.innerHTML = `<p><small>Bekleniyor‚Ä¶</small></p>`;
    return;
  }

  const hairList = getAssetList("hair");
  const topList = getAssetList("top");
  const bottomList = getAssetList("bottom");
  const shoesList = getAssetList("shoes");

  const h = hairList[(indices.hair ?? 0) % hairList.length];
  const t = topList[(indices.top ?? 0) % topList.length];
  const b = bottomList[(indices.bottom ?? 0) % bottomList.length];
  const s = shoesList[(indices.shoes ?? 0) % shoesList.length];

  target.innerHTML = `
    <svg viewBox="0 0 100 160" xmlns="http://www.w3.org/2000/svg" width="220" height="320">
      ${bodyBase}${h}${t}${b}${s}
    </svg>
  `;
}

function listenRoom(){
  rtdb.ref("rooms/" + roomCode).on("value", (snap)=>{
    const data = snap.val();
    if(!data){ leaveRoom(true); return; }
    drawCharacterFromIndices(data[slot]?.character, "my-character");
    const other = (slot === "p1") ? "p2" : "p1";
    drawCharacterFromIndices(data[other]?.character, "friend-character");
  });
}

function openOnline(){
  if(!firebaseReady){
    alert("Online i√ßin internet lazƒ±m. Net gidince Offline oynarsƒ±n.");
    return;
  }
  stopAnyGame();
  hideAll();
  showPanel("online");
}

async function createRoom(){
  if(!firebaseReady || !rtdb){
    alert("Online hazƒ±r deƒüil. ƒ∞nterneti a√ßƒ±p sayfayƒ± yenile.");
    return;
  }

  roomCode = generateRoomCode();
  slot = "p1";

  await rtdb.ref("rooms/" + roomCode).set({
    p1: { character: currentIndices },
    p2: null,
    createdAt: Date.now()
  });

  const rc = document.getElementById("room-code");
  if(rc) rc.textContent = "ODA: " + roomCode;

  hideAll();
  showPanel("room");
  drawCharacterFromIndices(currentIndices, "my-character");
  drawCharacterFromIndices(null, "friend-character");
  listenRoom();
}

async function joinRoom(){
  if(!firebaseReady || !rtdb){
    alert("Online hazƒ±r deƒüil. ƒ∞nterneti a√ßƒ±p sayfayƒ± yenile.");
    return;
  }

  const code = (document.getElementById("joinCode").value || "").trim();
  if(!/^\d{5}$/.test(code)) return alert("5 haneli kod gir!");

  roomCode = code;
  slot = "p2";

  const snap = await rtdb.ref("rooms/" + roomCode).once("value");
  if(!snap.exists()) return alert("Oda yok!");
  const data = snap.val();
  if(data.p2) return alert("Oda dolu!");

  await rtdb.ref("rooms/" + roomCode + "/p2").set({ character: currentIndices });

  const rc = document.getElementById("room-code");
  if(rc) rc.textContent = "ODA: " + roomCode;

  hideAll();
  showPanel("room");
  drawCharacterFromIndices(currentIndices, "my-character");
  listenRoom();
}

function leaveRoom(silent=false){
  if(roomCode && slot && rtdb){
    rtdb.ref("rooms/" + roomCode).off();
    if(slot === "p2") rtdb.ref("rooms/" + roomCode + "/p2").remove();
    else rtdb.ref("rooms/" + roomCode).remove();
  }
  roomCode = null;
  slot = null;
  if(!silent) backToMenu();
}

/* -------------------- CHANGE -------------------- */
function change(cat){
  const list = getAssetList(cat);
  currentIndices[cat] = (currentIndices[cat] + 1) % list.length;
  renderCharacter();

  const roomEl = document.getElementById("room");
  if(firebaseReady && rtdb && roomCode && slot){
    rtdb.ref(`rooms/${roomCode}/${slot}`).update({ character: currentIndices });
  }
  if(roomEl && !roomEl.classList.contains("hidden")){
    drawCharacterFromIndices(currentIndices, "my-character");
  }
}

/* -------------------- PAGES -------------------- */
function hideAll(){
  ["login","menu","creator","library","online","room","games","game"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.add("hidden");
  });
}
function showPanel(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.remove("hidden");
  el.classList.remove("neon-show");
  void el.offsetWidth;
  el.classList.add("neon-show");
}

function enterSite(){
  const nick = document.getElementById('nickname').value.trim();
  if(!nick) return alert("Takma ad bo≈ü olamaz!");
  LS.setStr("nickname", nick);
  document.getElementById("display-nick").textContent = nick;
  hideAll();
  showPanel("menu");
}
function openCreator(){ stopAnyGame(); hideAll(); showPanel("creator"); renderCharacter(); updateUnlockBadge(); }
function openLibrary(){ stopAnyGame(); hideAll(); showPanel("library"); loadLibrary(); }
function openGamesHub(){ stopAnyGame(); hideAll(); showPanel("games"); updateQuestUI(); }
function backToMenu(){ stopAnyGame(); hideAll(); showPanel("menu"); }

/* -------------------- UI -------------------- */
function updateUnlockBadge(){
  const b = document.getElementById("unlock-badge");
  if(!b) return;
  if(neonUnlocked()){
    b.innerHTML = `Neon Pack: <b>A√áIK</b> ‚úÖ`;
  }else{
    const p = getProgress();
    b.innerHTML = `Neon Pack: <b>Kƒ∞Lƒ∞TLƒ∞</b> üîí | G√ºnl√ºk g√∂rev: <b>${p.score}/20</b>`;
  }
}
function updateQuestUI(){
  const box = document.getElementById("quest-box");
  if(!box) return;
  const p = getProgress();
  let status = `G√ºnl√ºk g√∂rev: <b>20 puan</b> yap (${p.score}/20)`;
  if(p.completed) status = `G√ºnl√ºk g√∂rev: <b>TAMAM</b> ‚úÖ (20/20)`;
  box.innerHTML = `<p>${status}</p><p><small>Herhangi oyunda puan kazan yeter.</small></p>`;
}

/* -------------------- DOLAP (basit) -------------------- */
function saveCurrentCharacter(){
  const nick = LS.getStr("nickname","anon");
  const hairList = getAssetList("hair");
  const topList = getAssetList("top");
  const bottomList = getAssetList("bottom");
  const shoesList = getAssetList("shoes");

  const svg = `
  <svg viewBox="0 0 100 160" xmlns="http://www.w3.org/2000/svg">
    ${bodyBase}
    ${hairList[currentIndices.hair]}
    ${topList[currentIndices.top]}
    ${bottomList[currentIndices.bottom]}
    ${shoesList[currentIndices.shoes]}
  </svg>`;

  const saved = LS.get("savedCharacters", []);
  saved.push({ nick, svg, ts: Date.now() });
  LS.set("savedCharacters", saved);
  alert("Karakter kaydedildi!");
}
function loadLibrary(){
  const nick = LS.getStr("nickname","");
  const container = document.getElementById("dolap-list");
  if(!container) return;
  container.innerHTML = "";

  const saved = LS.get("savedCharacters", []);
  const my = saved.filter(x => x.nick === nick);
  if(my.length === 0){
    container.textContent = "Hen√ºz karakter yok.";
    return;
  }
  my.slice().reverse().forEach((c) => {
    const card = document.createElement("div");
    card.className = "character-card";
    card.innerHTML = `<div class="preview">${c.svg}</div><p>${c.nick}</p>`;
    card.onclick = () => {
      LS.setStr("activeCharacterSVG", c.svg);
      alert("Aktif karakter ayarlandƒ±!");
    };
    container.appendChild(card);
  });
}

/* -------------------- GAMES (sadece hub √ßalƒ±≈üsƒ±n diye minimal) -------------------- */
const canvas = document.getElementById("game-canvas");
const ctx = canvas.getContext("2d");
let currentGame = null;
let loopId = null;

function openGame(which){
  hideAll();
  showPanel("game");
  document.getElementById("btn-restart").onclick = () => startGame(which);
  startGame(which);
}
function startGame(which){
  stopAnyGame();
  currentGame = which;
  // basit placeholder (oyunlarƒ±nƒ± buraya geri koyabilirsin)
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#00ffff";
  ctx.font="10px 'Press Start 2P'";
  ctx.fillText("OYUN MODU", 110, 240);
  ctx.fillText(which.toUpperCase(), 120, 280);
  document.getElementById("hud").innerHTML = `Se√ßilen: <b>${which}</b>`;
}
function stopAnyGame(){
  if(loopId){ cancelAnimationFrame(loopId); loopId=null; }
  if(canvas) canvas.onclick = null;
  currentGame = null;
}

/* -------------------- INIT -------------------- */
window.onload = () => {
  hideAll();
  showPanel("login");

  document.getElementById("btn-enter").onclick = enterSite;
  document.getElementById("btn-creator").onclick = openCreator;
  document.getElementById("btn-library").onclick = openLibrary;
  document.getElementById("btn-games").onclick = openGamesHub;

  document.getElementById("nickname").addEventListener("keydown", (e)=>{
    if(e.key === "Enter") enterSite();
  });

  const savedNick = LS.getStr("nickname","");
  if(savedNick) document.getElementById("nickname").value = savedNick;

  updateQuestUI();
  updateUnlockBadge();
  renderCharacter();

  // firebase g√ºvenli ba≈ülat
  initFirebaseSafe();
  setOnlineBtnState();
};

/* globals */
window.change = change;
window.saveCurrentCharacter = saveCurrentCharacter;
window.backToMenu = backToMenu;
window.openGame = openGame;
window.openGamesHub = openGamesHub;
window.openOnline = openOnline;
window.createRoom = createRoom;
window.joinRoom = joinRoom;
window.leaveRoom = leaveRoom;
</script>

</body>
</html>
