<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pixel Master + Online Room + Chat + Games + Dolap</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
:root{ --neon-pink:#ff00ff; --neon-blue:#00ffff; --good:#00ff66; --bad:#ff3355; }
*{box-sizing:border-box;margin:0;padding:0;}
body,html{
  width:100%;height:100%;
  font-family:'Press Start 2P', cursive;
  background:radial-gradient(circle at 50% 50%,#1a1a2e 0%,#000 100%);
  color:#fff;
  display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
  padding:18px 10px;
}
.hidden{display:none !important;}

@keyframes neonFadeIn{
  0%{opacity:0; filter:drop-shadow(0 0 0px #ff00ff);}
  50%{opacity:.5; filter:drop-shadow(0 0 8px #ff00ff);}
  100%{opacity:1; filter:drop-shadow(0 0 20px #ff00ff);}
}
.neon-show{ animation:neonFadeIn .7s ease forwards; }

h2,p{ text-align:center; line-height:1.45; }
small{ opacity:.85; }

button{
  padding:10px 14px; cursor:pointer;
  font-family:'Press Start 2P';
  border:2px solid var(--neon-pink);
  color:var(--neon-pink);
  background:transparent;
  border-radius:10px;
  transition:.25s;
}
button:hover{ background:var(--neon-pink); color:#000; box-shadow:0 0 15px var(--neon-pink); }
button:disabled{ opacity:.45; cursor:not-allowed; }

input{
  padding:10px 12px;
  border-radius:10px;
  border:2px solid var(--neon-blue);
  background:#0b0b0f;
  color:#fff;
  font-family:'Press Start 2P';
  outline:none;
  width:min(420px, 90vw);
}

.controls{
  display:flex;justify-content:center;align-items:center;
  gap:10px;flex-wrap:wrap;margin-top:12px;
}

.panel{
  width:min(980px, 95vw);
  display:flex;flex-direction:column;align-items:center;
  gap:10px;
}

.badge{
  border:1px solid rgba(255,255,255,.25);
  padding:8px 10px;
  border-radius:12px;
  background:rgba(0,0,0,.35);
  width:min(900px, 95vw);
}
.badge b{ color:var(--neon-blue); }

#character-canvas{
  width:350px;height:480px;
  background:linear-gradient(145deg,#0c0c12,#1a1a2a);
  border:2px solid var(--neon-blue);
  border-radius:16px;
  display:flex;justify-content:center;align-items:center;
  box-shadow:0 0 15px rgba(255,0,255,.35);
  margin:10px 0;
}
#character-canvas svg{ width:100%; height:100%; }

#dolap-list{
  display:flex;flex-wrap:wrap;gap:14px;justify-content:center;
  padding:10px;max-width:95vw;
  overflow-y:auto;max-height:55vh;
}
.character-card{
  background:rgba(0,0,0,0.65);
  padding:10px;border:2px solid var(--neon-blue);
  border-radius:12px;text-align:center;width:200px;
  display:flex;flex-direction:column;align-items:center;gap:10px;
}
.character-card svg{width:92px;height:120px;}
.character-card .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.character-card .row button{ padding:8px 10px; font-size:10px; }

.topbar{
  position:fixed;
  top:10px; left:10px; right:10px;
  display:flex; align-items:center; justify-content:space-between;
  pointer-events:none;
  z-index:999;
}
.net-badge, .room-badge{
  pointer-events:none;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.25);
  background:rgba(0,0,0,.45);
  font-size:10px;
}
.net-badge b{ color:var(--good); }
.net-badge.off b{ color:var(--bad); }
.room-badge b{ color:var(--neon-blue); }

.online-stage{
  width:min(900px, 95vw);
  display:flex; gap:18px; justify-content:center; flex-wrap:wrap;
  margin-top:8px;
}
.avatar-box{
  width:380px; max-width:95vw;
  border:2px solid var(--neon-blue);
  border-radius:16px;
  background:rgba(0,0,0,.35);
  padding:12px;
  display:flex; flex-direction:column; align-items:center; gap:10px;
  box-shadow:0 0 15px rgba(0,255,255,.18);
}
.avatar-box h3{ font-size:12px; }
.avatar-preview{
  width:220px; height:300px;
  border:2px solid var(--neon-pink);
  border-radius:14px;
  display:flex; justify-content:center; align-items:center;
  background:linear-gradient(145deg,#0c0c12,#1a1a2a);
  box-shadow:0 0 15px rgba(255,0,255,.22);
}
.avatar-preview svg{ width:100%; height:100%; }
.sep{
  width:min(900px, 95vw);
  height:1px;
  background:rgba(255,255,255,.12);
  margin:8px 0;
}

/* GAMES */
.grid3{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap:10px;
  width:min(820px, 95vw);
}
@media (max-width:900px){
  .grid3{ grid-template-columns: 1fr; }
}
.game-btn{
  padding:14px 12px;
  border:2px solid var(--neon-blue);
  color:var(--neon-blue);
}
.game-btn:hover{ background:var(--neon-blue); color:#000; box-shadow:0 0 15px var(--neon-blue); }

#game-canvas{
  width:min(360px, 92vw);
  height:auto;
  border:2px solid var(--neon-pink);
  border-radius:12px;
  background:#0a0a0f;
  box-shadow:0 0 15px rgba(255,0,255,.28);
  touch-action: manipulation;
}

/* CHAT */
.chat-wrap{
  width:min(900px,95vw);
  border:1px solid rgba(255,255,255,.2);
  border-radius:14px;
  background:rgba(0,0,0,.35);
  padding:10px;
}
.chat-list{
  height:220px;
  overflow:auto;
  padding:8px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(0,0,0,.25);
}
.msg{
  font-size:10px;
  line-height:1.4;
  margin:6px 0;
  opacity:.95;
  word-break:break-word;
}
.msg b{ color:var(--neon-blue); }
.chat-row{
  display:flex;
  gap:10px;
  margin-top:10px;
  align-items:center;
  justify-content:center;
  flex-wrap:wrap;
}
.chat-row input{ width:min(620px, 95vw); }
</style>
</head>

<body>

<div class="topbar">
  <div class="room-badge" id="roomHud">ROOM: <b>---</b></div>
  <div class="net-badge off" id="netHud">NET: <b>OFF</b> ‚ùå</div>
</div>

<!-- LOGIN -->
<div id="login" class="panel neon-show">
  <p>Takma adƒ±nƒ± gir</p>
  <input id="nickname" placeholder="Takma ad" autocomplete="off" autocapitalize="off" spellcheck="false" />
  <button id="btn-enter">Gƒ∞R</button>
  <p><small>Not: Live Server ile a√ß.</small></p>
</div>

<!-- MENU -->
<div id="menu" class="panel hidden">
  <h2>Merhaba <span id="display-nick"></span>!</h2>
  <div class="controls">
    <button id="btn-library">Dolap</button>
    <button id="btn-creator">Karakter Olu≈ütur</button>
    <button id="btn-games">Oyunlar</button>
    <button id="btn-online">Online Mod</button>
  </div>
</div>

<!-- CREATOR -->
<div id="creator" class="panel hidden">
  <h2>Karakter Olu≈ütur</h2>
  <div class="badge" id="unlock-badge"></div>
  <div id="character-canvas"></div>
  <div class="controls">
    <button id="btn-hair">Sa√ß</button>
    <button id="btn-top">√úst</button>
    <button id="btn-bottom">Alt</button>
    <button id="btn-shoes">Ayakkabƒ±</button>
    <button id="btn-save">Kaydet</button>
    <button id="btn-back1">Men√º</button>
  </div>
</div>

<!-- LIBRARY -->
<div id="library" class="panel hidden">
  <h2>Dolap</h2>
  <p><small>AKTƒ∞F yapƒ±nca oyunlarda + online odada o karakter gider.</small></p>
  <div id="dolap-list"></div>
  <div class="controls">
    <button id="btn-back2">Men√º</button>
  </div>
</div>

<!-- GAMES HUB -->
<div id="games" class="panel hidden">
  <h2>OYUNLAR</h2>
  <div class="badge" id="quest-box"></div>

  <div class="grid3">
    <button class="game-btn" id="btn-g1">Neon Bounce</button>
    <button class="game-btn" id="btn-g2">Reaction Rush</button>
    <button class="game-btn" id="btn-g3">Neon Runner</button>
  </div>

  <div class="controls">
    <button id="btn-back-games">Men√º</button>
  </div>
</div>

<!-- GAME SCREEN -->
<div id="game" class="panel hidden">
  <h2 id="game-title">Oyun</h2>
  <div class="badge" id="hud"></div>
  <canvas id="game-canvas" width="360" height="520"></canvas>
  <div class="controls">
    <button id="btn-restart">Yeniden</button>
    <button id="btn-back-games2">Oyunlar</button>
    <button id="btn-back-menu2">Men√º</button>
  </div>
</div>

<!-- ONLINE -->
<div id="online" class="panel hidden">
  <h2>ONLINE MOD + CHAT</h2>
  <div class="badge">
    <p>Oda olu≈ütur veya koda gir.</p>
    <p><small>NET ON = Auth + DB baƒülantƒ±sƒ± tamam.</small></p>
  </div>

  <div class="controls">
    <button id="btn-create-room" style="border-color:var(--neon-blue);color:var(--neon-blue)">ODA OLU≈ûTUR</button>
    <input id="roomCodeInput" placeholder="5 haneli oda kodu" maxlength="5" />
    <button id="btn-join-room" style="border-color:var(--neon-blue);color:var(--neon-blue)">KATIL</button>
  </div>

  <div class="sep"></div>

  <div class="online-stage">
    <div class="avatar-box">
      <h3>Sen</h3>
      <div class="avatar-preview" id="p1Preview"></div>
      <div class="controls">
        <button id="btn-hair2">Sa√ß</button>
        <button id="btn-top2">√úst</button>
        <button id="btn-bottom2">Alt</button>
        <button id="btn-shoes2">Ayakkabƒ±</button>
        <button id="btn-sync" style="border-color:var(--good);color:var(--good)">SENKRONLA</button>
      </div>
      <p><small>Aktif karakter varsa o gider, yoksa edit√∂r g√∂r√ºn√ºm√º gider.</small></p>
    </div>

    <div class="avatar-box">
      <h3>Diƒüer Ki≈üi</h3>
      <div class="avatar-preview" id="p2Preview"><small>Baƒülanƒ±nca gelecek‚Ä¶</small></div>
      <p><small>Ger√ßek zamanlƒ± g√ºncellenir.</small></p>
    </div>
  </div>

  <div class="sep"></div>

  <div class="chat-wrap">
    <p style="text-align:center"><small>CHAT (oda i√ßindeyken aktif)</small></p>
    <div class="chat-list" id="chatList"></div>
    <div class="chat-row">
      <input id="chatInput" placeholder="Mesaj yaz (Enter)" maxlength="120" />
      <button id="btn-send" style="border-color:var(--neon-blue);color:var(--neon-blue)">G√ñNDER</button>
    </div>
  </div>

  <div class="controls">
    <button id="btn-leave-room" style="border-color:var(--bad);color:var(--bad)">ODADAN √áIK</button>
    <button id="btn-back3">Men√º</button>
  </div>
</div>

<script type="module">
/* -------------------- HELPERS -------------------- */
const LS = {
  get(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch{ return def; } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
  getStr(k, def=""){ return localStorage.getItem(k) ?? def; },
  setStr(k, v){ localStorage.setItem(k, v); }
};
const $ = (id)=>document.getElementById(id);

/* -------------------- NAV -------------------- */
function hideAll(){
  ["login","menu","creator","library","games","game","online"].forEach(id=>{
    const el = $(id);
    if(el) el.classList.add("hidden");
  });
}
function showPanel(id){
  const el = $(id);
  if(!el) return;
  el.classList.remove("hidden");
  el.classList.remove("neon-show");
  void el.offsetWidth;
  el.classList.add("neon-show");
}
function backToMenu(){
  stopAnyGame();
  hideAll();
  $("display-nick").textContent = LS.getStr("nickname","");
  showPanel("menu");
}
function openCreator(){
  stopAnyGame();
  hideAll(); showPanel("creator");
  updateUnlockBadge();
  renderCharacter();
}
function openLibrary(){
  stopAnyGame();
  hideAll(); showPanel("library");
  loadLibrary();
}
function openGamesHub(){
  stopAnyGame();
  hideAll(); showPanel("games");
  updateQuestUI();
}
function openOnline(){
  stopAnyGame();
  hideAll(); showPanel("online");
  renderOnlinePreviews();
  refreshChatUI();
}

/* -------------------- LOGIN -------------------- */
function enterSite(){
  const nick = $("nickname").value.trim();
  if(!nick) return alert("Takma ad bo≈ü olamaz!");
  LS.setStr("nickname", nick);
  $("display-nick").textContent = nick;
  hideAll(); showPanel("menu");
}

/* -------------------- DAILY QUEST / UNLOCK -------------------- */
function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function getProgress(){
  const p = LS.get("dailyProgress", null);
  const t = todayKey();
  if(!p || p.day !== t){
    const fresh = { day:t, score:0, completed:false, claimed:false };
    LS.set("dailyProgress", fresh);
    return fresh;
  }
  return p;
}
function saveProgress(p){ LS.set("dailyProgress", p); }

function addScoreToDaily(amount){
  const p = getProgress();
  if(p.completed) return;
  p.score = Math.max(0, (p.score||0) + amount);
  if(p.score >= 20){
    p.score = 20;
    p.completed = true;
  }
  saveProgress(p);
  updateQuestUI();
  updateUnlockBadge();
}

function claimReward(){
  const p = getProgress();
  if(!p.completed || p.claimed) return;
  p.claimed = true;
  saveProgress(p);
  LS.set("neonPackUnlocked", true);
  updateQuestUI();
  updateUnlockBadge();
  alert("NEON PACK a√ßƒ±ldƒ±! (ekstra sa√ß/√ºst/alt/ayakkabƒ±)");
}

function neonUnlocked(){ return !!LS.get("neonPackUnlocked", false); }

function updateUnlockBadge(){
  const b = $("unlock-badge");
  if(neonUnlocked()){
    b.innerHTML = `Neon Pack: <b>A√áIK</b> ‚úÖ`;
  }else{
    const p = getProgress();
    b.innerHTML = `Neon Pack: <b>Kƒ∞Lƒ∞TLƒ∞</b> üîí | G√ºnl√ºk: <b>${p.score}/20</b>`;
  }
}

function updateQuestUI(){
  const box = $("quest-box");
  const p = getProgress();
  let status = `G√ºnl√ºk g√∂rev: <b>20 puan</b> yap (${p.score}/20)`;
  if(p.completed) status = `G√ºnl√ºk g√∂rev: <b>TAMAM</b> ‚úÖ (20/20)`;

  let claim = "";
  if(p.completed && !p.claimed){
    claim = `<div class="controls" style="margin-top:10px">
      <button id="btn-claim" style="border-color:var(--good);color:var(--good)">√ñD√úL√ú AL</button>
    </div>`;
  }else if(p.claimed || neonUnlocked()){
    claim = `<p style="margin-top:10px;color:var(--good)">√ñd√ºl alƒ±ndƒ±: Neon Pack ‚úÖ</p>`;
  }

  box.innerHTML = `
    <p>${status}</p>
    <p><small>Not: Herhangi bir oyunda puan kazanman yeter.</small></p>
    ${claim}
  `;
  const btn = $("btn-claim");
  if(btn) btn.onclick = claimReward;
}

/* -------------------- CHARACTER ASSETS -------------------- */
const bodyBase = `
<rect x="35" y="30" width="30" height="30" fill="#ffdbac"/>
<rect x="40" y="60" width="20" height="40" fill="#ffdbac"/>
<rect x="40" y="100" width="9" height="40" fill="#ffdbac"/>
<rect x="51" y="100" width="9" height="40" fill="#ffdbac"/>
`;

const baseAssets = {
  hair:[
    `<rect x="35" y="25" width="30" height="10" fill="#4d2600"/>`,
    `<rect x="32" y="20" width="36" height="20" fill="#ffd700"/>`,
    `<rect x="30" y="18" width="40" height="22" fill="#00ffff"/>`,
    `<rect x="35" y="25" width="30" height="10" fill="#ff00ff"/>`,
    `<rect x="32" y="20" width="36" height="20" fill="#ff4500"/>`,
    `<rect x="30" y="18" width="40" height="22" fill="#00ff00"/>`,
    `<rect x="34" y="23" width="32" height="12" fill="#1e90ff"/>`,
    `<rect x="33" y="21" width="34" height="14" fill="#ff1493"/>`,
    `<rect x="35" y="22" width="30" height="15" fill="#ffa500"/>`,
    `<rect x="31" y="19" width="38" height="18" fill="#adff2f"/>`
  ],
  top:[
    `<rect x="40" y="60" width="20" height="35" fill="#ff0055"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#222"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#00ff00"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ff00ff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#1e90ff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ffa500"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#00ffff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#adff2f"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ff4500"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ff1493"/>`
  ],
  bottom:[
    `<rect x="40" y="95" width="9" height="45" fill="#2b2b80"/><rect x="51" y="95" width="9" height="45" fill="#2b2b80"/>`,
    `<rect x="40" y="95" width="20" height="15" fill="#555"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ff00ff"/><rect x="51" y="95" width="9" height="45" fill="#ff00ff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#00ffff"/><rect x="51" y="95" width="9" height="45" fill="#00ffff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ffa500"/><rect x="51" y="95" width="9" height="45" fill="#ffa500"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ff1493"/><rect x="51" y="95" width="9" height="45" fill="#ff1493"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#1e90ff"/><rect x="51" y="95" width="9" height="45" fill="#1e90ff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#00ff00"/><rect x="51" y="95" width="9" height="45" fill="#00ff00"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ff4500"/><rect x="51" y="95" width="9" height="45" fill="#ff4500"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#adff2f"/><rect x="51" y="95" width="9" height="45" fill="#adff2f"/>`
  ],
  shoes:[
    `<rect x="38" y="140" width="14" height="6" fill="#000"/><rect x="52" y="140" width="14" height="6" fill="#000"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#ff3355"/><rect x="52" y="140" width="14" height="6" fill="#ff3355"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#1e90ff"/><rect x="52" y="140" width="14" height="6" fill="#1e90ff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#00ff66"/><rect x="52" y="140" width="14" height="6" fill="#00ff66"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#ff00ff"/><rect x="52" y="140" width="14" height="6" fill="#ff00ff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#00ffff"/><rect x="52" y="140" width="14" height="6" fill="#00ffff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#ffd700"/><rect x="52" y="140" width="14" height="6" fill="#ffd700"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#555"/><rect x="52" y="140" width="14" height="6" fill="#555"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#fff"/><rect x="52" y="140" width="14" height="6" fill="#fff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#8b4513"/><rect x="52" y="140" width="14" height="6" fill="#8b4513"/>`
  ]
};

const neonPack = {
  hair:[
    `<rect x="29" y="18" width="42" height="20" fill="#9b5cff"/><rect x="31" y="22" width="38" height="6" fill="#00ffff"/>`,
    `<rect x="31" y="18" width="38" height="22" fill="#00ff66"/>`,
    `<rect x="30" y="20" width="40" height="18" fill="#ff3355"/>`,
    `<rect x="32" y="18" width="36" height="22" fill="#ffffff"/><rect x="33" y="22" width="34" height="4" fill="#ff00ff"/>`,
    `<rect x="30" y="18" width="40" height="22" fill="#222"/><rect x="30" y="18" width="40" height="4" fill="#00ffff"/>`
  ],
  top:[
    `<rect x="40" y="60" width="20" height="35" fill="#9b5cff"/><rect x="40" y="74" width="20" height="4" fill="#00ffff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#00ff66"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#ff3355"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#fff"/><rect x="40" y="66" width="20" height="4" fill="#ff00ff"/>`,
    `<rect x="40" y="60" width="20" height="35" fill="#111"/><rect x="40" y="60" width="20" height="3" fill="#00ffff"/>`
  ],
  bottom:[
    `<rect x="40" y="95" width="9" height="45" fill="#9b5cff"/><rect x="51" y="95" width="9" height="45" fill="#9b5cff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#00ff66"/><rect x="51" y="95" width="9" height="45" fill="#00ff66"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#ff3355"/><rect x="51" y="95" width="9" height="45" fill="#ff3355"/>`,
    `<rect x="40" y="95" width="20" height="15" fill="#fff"/><rect x="40" y="110" width="20" height="3" fill="#ff00ff"/>`,
    `<rect x="40" y="95" width="9" height="45" fill="#111"/><rect x="51" y="95" width="9" height="45" fill="#111"/><rect x="40" y="95" width="20" height="3" fill="#00ffff"/>`
  ],
  shoes:[
    `<rect x="38" y="140" width="14" height="6" fill="#9b5cff"/><rect x="52" y="140" width="14" height="6" fill="#9b5cff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#00ff66"/><rect x="52" y="140" width="14" height="6" fill="#00ff66"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#ff3355"/><rect x="52" y="140" width="14" height="6" fill="#ff3355"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#fff"/><rect x="52" y="140" width="14" height="6" fill="#fff"/>`,
    `<rect x="38" y="140" width="14" height="6" fill="#111"/><rect x="52" y="140" width="14" height="6" fill="#111"/><rect x="38" y="140" width="28" height="2" fill="#00ffff"/>`
  ]
};

function getAssetList(cat){
  const base = baseAssets[cat];
  return neonUnlocked() ? base.concat(neonPack[cat]) : base;
}

let currentIndices = { hair:0, top:0, bottom:0, shoes:0 };

function makeSvgFromIndices(indices){
  const hairList = getAssetList("hair");
  const topList = getAssetList("top");
  const bottomList = getAssetList("bottom");
  const shoesList = getAssetList("shoes");

  const h = ((indices.hair % hairList.length)+hairList.length)%hairList.length;
  const t = ((indices.top % topList.length)+topList.length)%topList.length;
  const b = ((indices.bottom % bottomList.length)+bottomList.length)%bottomList.length;
  const s = ((indices.shoes % shoesList.length)+shoesList.length)%shoesList.length;

  return `
  <svg viewBox="0 0 100 160" xmlns="http://www.w3.org/2000/svg">
    ${bodyBase}
    ${hairList[h]}
    ${topList[t]}
    ${bottomList[b]}
    ${shoesList[s]}
  </svg>`;
}

function renderCharacter(){
  $("character-canvas").innerHTML = makeSvgFromIndices(currentIndices);
}

function change(cat){
  const list = getAssetList(cat);
  currentIndices[cat] = (currentIndices[cat] + 1) % list.length;
  renderCharacter();
  if(roomState.inRoom) pushMyState().catch(()=>{});
}

function getMyDisplaySvg(){
  const active = LS.getStr("activeCharacterSVG","");
  return active || makeSvgFromIndices(currentIndices);
}

/* -------------------- DOLAP -------------------- */
function saveCurrentCharacter(){
  const nick = LS.getStr("nickname","anon");
  const svg = makeSvgFromIndices(currentIndices);
  const saved = LS.get("savedCharacters", []);
  saved.push({ nick, svg, ts: Date.now() });
  LS.set("savedCharacters", saved);
  alert("Karakter kaydedildi!");
}

function loadLibrary(){
  const nick = LS.getStr("nickname","");
  const container = $("dolap-list");
  container.innerHTML = "";

  const saved = LS.get("savedCharacters", []);
  const my = saved.filter(x => x.nick === nick).slice().reverse();

  if(my.length === 0){
    container.innerHTML = "<p>Hen√ºz karakter yok.</p>";
    return;
  }

  for(const c of my){
    const card = document.createElement("div");
    card.className = "character-card";
    card.innerHTML = `
      <div class="preview">${c.svg}</div>
      <div class="row">
        <button class="btnActive" style="border-color:var(--neon-blue);color:var(--neon-blue)">AKTƒ∞F</button>
        <button class="btnDel" style="border-color:var(--bad);color:var(--bad)">Sƒ∞L</button>
      </div>
      <small>${new Date(c.ts).toLocaleString()}</small>
    `;

    card.querySelector(".btnActive").onclick = (ev) => {
      ev.stopPropagation();
      LS.setStr("activeCharacterSVG", c.svg);
      alert("Aktif karakter ayarlandƒ±!");
      // online a√ßƒ±ksa anƒ±nda g√∂nder
      if(roomState.inRoom) pushMyState().catch(()=>{});
    };

    card.querySelector(".btnDel").onclick = (ev) => {
      ev.stopPropagation();
      const all = LS.get("savedCharacters", []);
      const kept = all.filter(x => !(x.nick===c.nick && x.ts===c.ts));
      LS.set("savedCharacters", kept);
      loadLibrary();
    };

    container.appendChild(card);
  }
}

/* -------------------- FIREBASE (ONLINE + CHAT) -------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getDatabase, ref, set, update, onValue, get, remove, onDisconnect,
  push, onChildAdded, query, limitToLast
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyABqkhpL1SMRzRJ9GQLjjZE2IryqpAvMPw",
  authDomain: "pixelroom-ae218.firebaseapp.com",
  databaseURL: "https://pixelroom-ae218-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "pixelroom-ae218",
  storageBucket: "pixelroom-ae218.firebasestorage.app",
  messagingSenderId: "720297722320",
  appId: "1:720297722320:web:c815edae99d1efa7ff39d5",
  measurementId: "G-HD8901B19M"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const netHud = $("netHud");
const roomHud = $("roomHud");

const roomState = {
  uid: null,
  inRoom: false,
  roomId: null,
  role: null,   // "p1" | "p2"
  unsubRoom: null,
  unsubChat: null,
  connected: false
};

function setNetUI(on){
  if(on){
    netHud.classList.remove("off");
    netHud.innerHTML = `NET: <b>ON</b> ‚úÖ`;
  }else{
    netHud.classList.add("off");
    netHud.innerHTML = `NET: <b>OFF</b> ‚ùå`;
  }
}
function updateRoomUI(){
  roomHud.innerHTML = `ROOM: <b>${roomState.roomId ?? "---"}</b>`;
}
function randomRoomCode(){
  return String(Math.floor(10000 + Math.random()*90000));
}

async function ensureAuth(){
  if(roomState.uid) return roomState.uid;
  await signInAnonymously(auth);
  return new Promise((resolve, reject) => {
    const off = onAuthStateChanged(auth, (u)=>{
      if(u){
        roomState.uid = u.uid;
        off();
        resolve(u.uid);
      }
    });
    setTimeout(()=>reject(new Error("Auth timeout")), 7000);
  });
}

function renderOnlinePreviews(){
  $("p1Preview").innerHTML = getMyDisplaySvg();
  if(!roomState.inRoom){
    $("p2Preview").innerHTML = "<small>Baƒülanƒ±nca gelecek‚Ä¶</small>";
  }
}

async function createRoom(){
  await ensureAuth();
  const roomId = randomRoomCode();
  const roomRef = ref(db, `rooms/${roomId}`);
  const nick = LS.getStr("nickname","anon");

  await set(roomRef, {
    createdAt: Date.now(),
    p1: { uid: roomState.uid, nick, svg: getMyDisplaySvg(), ts: Date.now() }
  });

  roomState.inRoom = true;
  roomState.roomId = roomId;
  roomState.role = "p1";
  updateRoomUI();

  onDisconnect(roomRef).remove().catch(()=>{});
  listenRoom(roomId);

  alert("Oda kuruldu: " + roomId);
  renderOnlinePreviews();
  refreshChatUI();
}

async function joinRoom(roomId){
  await ensureAuth();
  roomId = String(roomId||"").trim();
  if(!/^\d{5}$/.test(roomId)) return alert("Oda kodu 5 haneli olmalƒ±!");

  const roomRef = ref(db, `rooms/${roomId}`);
  const snap = await get(roomRef);
  if(!snap.exists()) return alert("Oda bulunamadƒ±!");

  const data = snap.val();
  if(!data.p1) return alert("Oda bozuk (p1 yok).");
  if(data.p2 && data.p2.uid && data.p2.uid !== roomState.uid) return alert("Oda dolu!");

  const nick = LS.getStr("nickname","anon");
  await update(roomRef, {
    p2: { uid: roomState.uid, nick, svg: getMyDisplaySvg(), ts: Date.now() }
  });

  roomState.inRoom = true;
  roomState.roomId = roomId;
  roomState.role = "p2";
  updateRoomUI();

  const p2Ref = ref(db, `rooms/${roomId}/p2`);
  onDisconnect(p2Ref).remove().catch(()=>{});

  listenRoom(roomId);
  alert("Odaya girdin: " + roomId);
  renderOnlinePreviews();
  refreshChatUI();
}

function listenRoom(roomId){
  if(roomState.unsubRoom) roomState.unsubRoom();
  const roomRef = ref(db, `rooms/${roomId}`);

  const unsubscribe = onValue(roomRef, (snap)=>{
    if(!snap.exists()){
      roomState.inRoom = false;
      roomState.roomId = null;
      roomState.role = null;
      updateRoomUI();
      $("p2Preview").innerHTML = "<small>Oda kapandƒ±.</small>";
      stopChatListen();
      refreshChatUI();
      return;
    }

    const data = snap.val();
    if(roomState.role === "p1"){
      $("p1Preview").innerHTML = getMyDisplaySvg();
      $("p2Preview").innerHTML = (data.p2 && data.p2.svg) ? data.p2.svg : "<small>Arkada≈ü bekleniyor‚Ä¶</small>";
    }else if(roomState.role === "p2"){
      $("p1Preview").innerHTML = getMyDisplaySvg();
      $("p2Preview").innerHTML = (data.p1 && data.p1.svg) ? data.p1.svg : "<small>p1 yok‚Ä¶</small>";
    }
    updateRoomUI();
  });

  roomState.unsubRoom = unsubscribe;
}

async function pushMyState(){
  if(!roomState.inRoom || !roomState.roomId || !roomState.role) return;
  const nick = LS.getStr("nickname","anon");
  const svg = getMyDisplaySvg();
  const meRef = ref(db, `rooms/${roomState.roomId}/${roomState.role}`);
  await update(meRef, { uid: roomState.uid, nick, svg, ts: Date.now() });
  $("p1Preview").innerHTML = svg;
}

async function leaveRoom(){
  if(!roomState.inRoom || !roomState.roomId) return;

  const roomId = roomState.roomId;
  const role = roomState.role;

  try{
    if(role === "p1") await remove(ref(db, `rooms/${roomId}`));
    else await remove(ref(db, `rooms/${roomId}/p2`));
  }catch(e){}

  if(roomState.unsubRoom) roomState.unsubRoom();
  roomState.unsubRoom = null;

  roomState.inRoom = false;
  roomState.roomId = null;
  roomState.role = null;
  updateRoomUI();

  stopChatListen();
  refreshChatUI();
  renderOnlinePreviews();
  alert("Odadan √ßƒ±ktƒ±n.");
}

/* DB CONNECTED -> NET */
onValue(ref(db, ".info/connected"), (snap)=>{
  roomState.connected = !!snap.val();
  setNetUI(roomState.connected && !!roomState.uid);
});

/* Auth state */
onAuthStateChanged(auth, (u)=>{
  roomState.uid = u ? u.uid : null;
  setNetUI(roomState.connected && !!roomState.uid);
});

/* -------------------- CHAT -------------------- */
function stopChatListen(){
  if(roomState.unsubChat) roomState.unsubChat();
  roomState.unsubChat = null;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function addMsgToUI(nick, text){
  const div = document.createElement("div");
  div.className = "msg";
  div.innerHTML = `<b>${escapeHtml(nick)}</b>: ${escapeHtml(text)}`;
  $("chatList").appendChild(div);
  $("chatList").scrollTop = $("chatList").scrollHeight;
}
function refreshChatUI(){
  $("chatList").innerHTML = "";
  if(!roomState.inRoom || !roomState.roomId){
    $("chatList").innerHTML = `<div class="msg"><small>Chat i√ßin odaya girmen lazƒ±m.</small></div>`;
    return;
  }
  $("chatList").innerHTML = `<div class="msg"><small>Chat hazƒ±r. Mesaj yaz.</small></div>`;
  startChatListen();
}
function startChatListen(){
  stopChatListen();
  if(!roomState.inRoom || !roomState.roomId) return;

  const chatRef = ref(db, `rooms/${roomState.roomId}/chat`);
  const q = query(chatRef, limitToLast(40));

  $("chatList").innerHTML = "";
  const unsubscribe = onChildAdded(q, (snap)=>{
    const m = snap.val();
    if(!m || !m.text) return;
    addMsgToUI(m.nick || "anon", m.text);
  });
  roomState.unsubChat = unsubscribe;
}
async function sendChat(){
  if(!roomState.inRoom || !roomState.roomId) return alert("√ñnce odaya gir!");
  const txt = $("chatInput").value.trim();
  if(!txt) return;

  await ensureAuth();
  const nick = LS.getStr("nickname","anon");
  const chatRef = ref(db, `rooms/${roomState.roomId}/chat`);
  await push(chatRef, { uid: roomState.uid, nick, text: txt, ts: Date.now() });
  $("chatInput").value = "";
}

/* -------------------- GAMES (3 oyun) -------------------- */
let canvas, ctx;
let currentGame = null;

let particles = [];
let shake = 0;

function spawnParticles(x,y, count=14){
  for(let i=0;i<count;i++){
    particles.push({
      x,y,
      vx:(Math.random()-0.5)*5,
      vy:(Math.random()-0.5)*5,
      life: 18 + Math.random()*10
    });
  }
}
function updateParticles(){
  for(const p of particles){
    p.x += p.vx;
    p.y += p.vy;
    p.vx *= 0.95;
    p.vy *= 0.95;
    p.life -= 1;
  }
  particles = particles.filter(p => p.life > 0);
}
function drawParticles(){
  for(const p of particles){
    ctx.save();
    ctx.globalAlpha = Math.max(0, p.life/28);
    ctx.fillStyle = "#ff00ff";
    ctx.beginPath();
    ctx.arc(p.x, p.y, 2.2, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }
}
function addShake(power=7){ shake = Math.max(shake, power); }

function drawActiveAvatar(){
  const svg = LS.getStr("activeCharacterSVG","");
  ctx.save();
  ctx.globalAlpha = 0.9;
  ctx.fillStyle = "rgba(0,0,0,0.35)";
  ctx.fillRect(8, 8, 92, 62);
  ctx.strokeStyle = "#00ffff";
  ctx.lineWidth = 2;
  ctx.strokeRect(8, 8, 92, 62);
  ctx.fillStyle = "#00ffff";
  ctx.font = "10px 'Press Start 2P'";
  ctx.fillText(svg ? "AKTIF" : "YOK", 18, 34);
  ctx.restore();
}

function openGame(which){
  hideAll();
  showPanel("game");
  $("btn-restart").onclick = () => startGame(which);
  startGame(which);
}

function startGame(which){
  stopAnyGame();
  currentGame = which;
  if(which === "bounce") startBounce();
  else if(which === "reaction") startReaction();
  else if(which === "runner") startRunner();
}

function stopAnyGame(){
  stopBounce();
  stopReaction();
  stopRunner();
  currentGame = null;
  if(canvas) canvas.onclick = null;
  particles = [];
  shake = 0;
}

/* GAME 1: NEON BOUNCE */
let bounceInterval = null;
let bounce = null;

function startBounce(){
  $("game-title").textContent = "Neon Bounce";
  bounce = {
    score:0,
    lives:3,
    wallH: 14,
    ball:{ x:canvas.width/2, y:canvas.height/2, dx:2.4, dy:-3.1, r:10 },
    speedUpEvery: 10
  };

  canvas.onclick = () => { bounce.ball.dy *= -1; };

  bounceInterval = setInterval(() => {
    ctx.save();
    ctx.fillStyle = "rgba(10,10,15,0.22)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.restore();

    let sx = 0, sy = 0;
    if(shake > 0){
      sx = (Math.random()-0.5) * shake;
      sy = (Math.random()-0.5) * shake;
      shake *= 0.82;
      if(shake < 0.7) shake = 0;
    }

    ctx.save();
    ctx.translate(sx, sy);

    ctx.fillStyle = "red";
    ctx.fillRect(0,0,canvas.width,bounce.wallH);

    ctx.fillStyle = "yellow";
    ctx.beginPath();
    ctx.arc(bounce.ball.x, bounce.ball.y, bounce.ball.r, 0, Math.PI*2);
    ctx.fill();

    const b = bounce.ball;
    b.x += b.dx;
    b.y += b.dy;

    let bounced = false;

    if(b.x + b.r > canvas.width){ b.x = canvas.width - b.r; b.dx *= -1; bounced = true; }
    if(b.x - b.r < 0){ b.x = b.r; b.dx *= -1; bounced = true; }

    if(b.y - b.r < bounce.wallH){
      b.y = bounce.wallH + b.r;
      b.dy *= -1;
      bounced = true;
      bounce.score += 1;
      addScoreToDaily(1);

      if(bounce.score % bounce.speedUpEvery === 0){
        b.dx *= 1.08;
        b.dy *= 1.08;
      }
    }

    if(b.y + b.r > canvas.height){
      bounce.lives -= 1;
      spawnParticles(b.x, canvas.height - 10, 28);
      addShake(12);

      if(bounce.lives <= 0){
        bounce.lives = 0;
        canvas.onclick = null;
        stopBounce();
        $("hud").innerHTML =
          `SKOR: <b>${bounce.score}</b> | CAN: <b style="color:var(--bad)">0</b><br><small>Yeniden‚Äôe bas</small>`;
        ctx.restore();
        return;
      }else{
        b.x = canvas.width/2; b.y = canvas.height/2;
        b.dx = 2.4; b.dy = -3.1;
      }
    }

    if(bounced){
      spawnParticles(b.x, b.y, 14);
      addShake(7);
    }

    updateParticles();
    drawParticles();
    drawActiveAvatar();
    ctx.restore();

    $("hud").innerHTML =
      `SKOR: <b>${bounce.score}</b> | CAN: <b>${bounce.lives}</b><br><small>Topa tƒ±kla: y√∂n deƒüi≈ütir</small>`;
  }, 16);
}
function stopBounce(){
  if(bounceInterval){
    clearInterval(bounceInterval);
    bounceInterval = null;
  }
}

/* GAME 2: REACTION RUSH */
let reaction = null;
let reactionTimer = null;
let reactionStateTimer = null;

function startReaction(){
  $("game-title").textContent = "Reaction Rush";
  reaction = {
    best: LS.get("bestReactionMs", null),
    startedAt: null,
    canClick:false,
    round: 0,
    score: 0,
    target: null
  };

  ctx.fillStyle = "rgba(10,10,15,1)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  function scheduleRound(){
    reaction.canClick = false;
    reaction.startedAt = null;
    reaction.round += 1;

    ctx.fillStyle = "rgba(10,10,15,1)";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle = "#00ffff";
    ctx.font = "12px 'Press Start 2P'";
    ctx.fillText("BEKLE...", 110, 250);

    const delay = 900 + Math.random()*1600;

    reactionStateTimer = setTimeout(() => {
      reaction.canClick = true;
      reaction.startedAt = performance.now();

      ctx.fillStyle = "rgba(10,10,15,1)";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      const tx = 90 + Math.random()*(canvas.width-180);
      const ty = 120 + Math.random()*(canvas.height-240);
      reaction.target = { x:tx, y:ty, r:32 };

      ctx.save();
      ctx.shadowColor = "#ff00ff";
      ctx.shadowBlur = 25;
      ctx.fillStyle = "#ff00ff";
      ctx.beginPath(); ctx.arc(tx,ty,32,0,Math.PI*2); ctx.fill();
      ctx.restore();

      ctx.fillStyle = "#000";
      ctx.font = "10px 'Press Start 2P'";
      ctx.fillText("TIKLA", tx-22, ty+4);

      $("hud").innerHTML =
        `ROUND: <b>${reaction.round}</b> | PUAN: <b>${reaction.score}</b><br><small>Hedef √ßƒ±kƒ±nca tƒ±kla</small>`;
    }, delay);
  }

  canvas.onclick = (e) => {
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * (canvas.width / rect.width);
    const my = (e.clientY - rect.top) * (canvas.height / rect.height);

    if(!reaction.canClick){
      reaction.score = Math.max(0, reaction.score - 1);
      spawnParticles(mx,my,18);
      addShake(10);
      $("hud").innerHTML =
        `ERKEN! PUAN: <b>${reaction.score}</b><br><small>Hedef √ßƒ±kƒ±nca bas</small>`;
      return;
    }

    const dx = mx - reaction.target.x;
    const dy = my - reaction.target.y;
    const dist = Math.sqrt(dx*dx + dy*dy);

    if(dist <= reaction.target.r){
      const ms = Math.round(performance.now() - reaction.startedAt);

      let gained = 1;
      if(ms < 250) gained = 3;
      else if(ms < 400) gained = 2;

      reaction.score += gained;
      addScoreToDaily(gained);

      if(reaction.best === null || ms < reaction.best){
        reaction.best = ms;
        LS.set("bestReactionMs", ms);
      }

      spawnParticles(reaction.target.x, reaction.target.y, 30);
      addShake(8);

      ctx.fillStyle = "rgba(10,10,15,1)";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.fillStyle = "#00ff66";
      ctx.font = "12px 'Press Start 2P'";
      ctx.fillText("S√úPER!", 120, 220);
      ctx.fillStyle = "#00ffff";
      ctx.font = "10px 'Press Start 2P'";
      ctx.fillText(`TEPKƒ∞: ${ms}ms`, 85, 260);
      ctx.fillText(`BEST: ${reaction.best}ms`, 85, 290);

      $("hud").innerHTML =
        `PUAN: <b>${reaction.score}</b> | SON: <b>${ms}ms</b> | BEST: <b>${reaction.best}ms</b>`;

      reaction.canClick = false;
      clearTimeout(reactionTimer);
      reactionTimer = setTimeout(scheduleRound, 900);
    }else{
      reaction.score = Math.max(0, reaction.score - 1);
      spawnParticles(mx,my,14);
      addShake(6);
      $("hud").innerHTML =
        `ISKA! PUAN: <b>${reaction.score}</b><br><small>Hedefe bas</small>`;
    }
  };

  scheduleRound();
}
function stopReaction(){
  if(reactionStateTimer){ clearTimeout(reactionStateTimer); reactionStateTimer = null; }
  if(reactionTimer){ clearTimeout(reactionTimer); reactionTimer = null; }
}

/* GAME 3: NEON RUNNER */
let runnerInterval = null;
let runner = null;

function startRunner(){
  $("game-title").textContent = "Neon Runner";
  runner = {
    score: 0,
    lives: 3,
    y: canvas.height - 70,
    vy: 0,
    onGround: true,
    obstacles: [],
    t: 0,
    speed: 3.2
  };

  canvas.onclick = () => {
    if(runner.onGround){
      runner.vy = -10.8;
      runner.onGround = false;
      spawnParticles(70, runner.y+30, 18);
      addShake(6);
    }
  };

  runnerInterval = setInterval(() => {
    ctx.fillStyle = "rgba(10,10,15,0.25)";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    let sx=0, sy=0;
    if(shake>0){
      sx=(Math.random()-0.5)*shake;
      sy=(Math.random()-0.5)*shake;
      shake*=0.82;
      if(shake<0.7) shake=0;
    }

    ctx.save();
    ctx.translate(sx, sy);

    ctx.strokeStyle = "#00ffff";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(0, canvas.height-40);
    ctx.lineTo(canvas.width, canvas.height-40);
    ctx.stroke();

    const px = 70, pw = 26, ph = 34;
    runner.vy += 0.55;
    runner.y += runner.vy;
    if(runner.y > canvas.height-40 - ph){
      runner.y = canvas.height-40 - ph;
      runner.vy = 0;
      runner.onGround = true;
    }

    ctx.save();
    ctx.shadowColor = "#ff00ff";
    ctx.shadowBlur = 18;
    ctx.fillStyle = "#ff00ff";
    ctx.fillRect(px, runner.y, pw, ph);
    ctx.restore();

    runner.t++;
    if(runner.t % 70 === 0){
      const h = 20 + Math.random()*28;
      runner.obstacles.push({ x: canvas.width + 10, w: 20 + Math.random()*22, h });
    }

    for(const ob of runner.obstacles){
      ob.x -= runner.speed;

      ctx.save();
      ctx.shadowColor = "#00ffff";
      ctx.shadowBlur = 14;
      ctx.fillStyle = "#00ffff";
      ctx.fillRect(ob.x, canvas.height-40 - ob.h, ob.w, ob.h);
      ctx.restore();

      const ox = ob.x, oy = canvas.height-40 - ob.h, ow = ob.w, oh = ob.h;
      const hit =
        px < ox+ow && px+pw > ox &&
        runner.y < oy+oh && runner.y+ph > oy;

      if(hit){
        runner.lives -= 1;
        spawnParticles(px+pw, runner.y+ph/2, 32);
        addShake(14);
        ob.x = -9999;

        if(runner.lives <= 0){
          runner.lives = 0;
          stopRunner();
          canvas.onclick = null;
          $("hud").innerHTML =
            `SKOR: <b>${runner.score}</b> | CAN: <b style="color:var(--bad)">0</b><br><small>Yeniden‚Äôe bas</small>`;
          ctx.restore();
          return;
        }
      }
    }

    runner.obstacles = runner.obstacles.filter(ob => ob.x > -60);

    runner.score += 1;
    if(runner.score % 120 === 0) runner.speed *= 1.06;
    if(runner.score % 30 === 0) addScoreToDaily(1);

    updateParticles();
    drawParticles();
    drawActiveAvatar();
    ctx.restore();

    $("hud").innerHTML =
      `SKOR: <b>${runner.score}</b> | CAN: <b>${runner.lives}</b><br><small>Tƒ±kla: zƒ±pla</small>`;
  }, 16);
}
function stopRunner(){
  if(runnerInterval){
    clearInterval(runnerInterval);
    runnerInterval = null;
  }
}

/* -------------------- INIT -------------------- */
function init(){
  hideAll();
  showPanel("login");

  // canvas init (null olmasƒ±n diye burada)
  canvas = $("game-canvas");
  ctx = canvas.getContext("2d");

  // Login
  $("btn-enter").onclick = enterSite;
  $("nickname").addEventListener("keydown", (e)=>{ if(e.key==="Enter") enterSite(); });
  const savedNick = LS.getStr("nickname","");
  if(savedNick) $("nickname").value = savedNick;
  $("nickname").focus();

  // Menu
  $("btn-library").onclick = openLibrary;
  $("btn-creator").onclick = openCreator;
  $("btn-games").onclick = openGamesHub;
  $("btn-online").onclick = openOnline;

  // Creator
  $("btn-hair").onclick = ()=>change("hair");
  $("btn-top").onclick = ()=>change("top");
  $("btn-bottom").onclick = ()=>change("bottom");
  $("btn-shoes").onclick = ()=>change("shoes");
  $("btn-save").onclick = saveCurrentCharacter;
  $("btn-back1").onclick = backToMenu;

  // Library
  $("btn-back2").onclick = backToMenu;

  // Games
  $("btn-g1").onclick = ()=>openGame("bounce");
  $("btn-g2").onclick = ()=>openGame("reaction");
  $("btn-g3").onclick = ()=>openGame("runner");
  $("btn-back-games").onclick = backToMenu;

  // Game screen
  $("btn-back-games2").onclick = openGamesHub;
  $("btn-back-menu2").onclick = backToMenu;

  // Online
  $("btn-back3").onclick = backToMenu;
  $("btn-create-room").onclick = createRoom;
  $("btn-join-room").onclick = ()=>joinRoom($("roomCodeInput").value);
  $("btn-leave-room").onclick = leaveRoom;
  $("btn-sync").onclick = pushMyState;

  $("btn-hair2").onclick = ()=>change("hair");
  $("btn-top2").onclick = ()=>change("top");
  $("btn-bottom2").onclick = ()=>change("bottom");
  $("btn-shoes2").onclick = ()=>change("shoes");

  // Chat
  $("btn-send").onclick = sendChat;
  $("chatInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendChat(); });

  // UI initial
  updateRoomUI();
  updateQuestUI();
  updateUnlockBadge();
  renderCharacter();
  renderOnlinePreviews();
  refreshChatUI();

  // Auth (NET ON i√ßin)
  ensureAuth().catch((e)=>{
    console.log("AUTH FAIL:", e);
  });
}

if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
else init();
</script>

</body>
</html>
